<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTA PAL Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // Simple Database System (embedded for reliability - same as index.html)
        class UserDatabase {
            constructor() {
                this.databaseKey = 'kotapal_users_db';
                this.users = this.loadUsers();
                console.log('✅ Database initialized with', this.users.length, 'users');
            }

            loadUsers() {
                try {
                    const stored = localStorage.getItem(this.databaseKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        return data.users || [];
                    }
                } catch (e) {
                    console.log('Error loading database:', e);
                }
                return [];
            }

            saveUsers() {
                try {
                    const data = {
                        users: this.users,
                        lastUpdated: new Date().toISOString(),
                        version: '1.0'
                    };
                    localStorage.setItem(this.databaseKey, JSON.stringify(data));
                    console.log('✅ Database saved:', this.users.length, 'users');
                    return true;
                } catch (e) {
                    console.error('Error saving database:', e);
                    return false;
                }
            }

            findUserByEmail(email) {
                const normalizedEmail = email.toLowerCase().trim();
                return this.users.find(user => user.email === normalizedEmail);
            }

            authenticateUser(email, password) {
                try {
                    const user = this.findUserByEmail(email);
                    if (!user) {
                        throw new Error('User not found');
                    }

                    if (user.password !== password) {
                        throw new Error('Invalid password');
                    }

                    // Update last login
                    user.lastLogin = new Date().toISOString();
                    this.saveUsers();

                    return user;
                } catch (e) {
                    console.error('Authentication error:', e);
                    throw e;
                }
            }
        }

        // Initialize database
        window.userDB = new UserDatabase();
    </script>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --light: #f9fafb;
            --dark: #1f2937;
            --gray: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #333;
            line-height: 1.6;
            background-color: #f5f7fa;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        section {
            padding: 20px 0;
        }
        h1, h2, h3, h4, h5 {
            margin-bottom: 1rem;
            font-weight: 700;
            line-height: 1.2;
        }
        h1 {
            font-size: 2rem;
        }
        h2 {
            font-size: 1.75rem;
        }
        h3 {
            font-size: 1.5rem;
        }
        p {
            margin-bottom: 1.5rem;
        }
        a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        a:hover {
            color: var(--primary-dark);
        }
        button, .btn {
            cursor: pointer;
            border: none;
            border-radius: 50px;
            padding: 12px 28px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .text-center {
            text-align: center;
        }
        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        .sidebar-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        .sidebar-toggle-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .sidebar-toggle-btn:active {
            transform: scale(0.95);
        }
        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: flex-start;
        }
        .logo img {
            display: block !important;
            max-width: 150px;
            height: auto;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 10px;
        }
        .logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--dark);
        }
        .user-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .user-name {
            font-weight: 600;
        }
        .user-plan {
            font-size: 0.8rem;
            color: var(--gray);
            padding: 4px 8px;
            border-radius: 12px;
            background: #f3f4f6;
            display: inline-block;
        }
        .user-plan.starter {
            background: #dbeafe;
            color: #1e40af;
        }
        .user-plan.pro {
            background: #dcfce7;
            color: #166534;
        }
        .user-plan.creatorplus {
            background: #fef3c7;
            color: #92400e;
        }
        .nav-menu {
            list-style: none;
            padding: 0 10px;
        }
        .nav-item {
            margin-bottom: 5px;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--gray);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: #f5f7fa;
            color: var(--primary);
        }
        .nav-link.active {
            background: var(--primary);
            color: white;
        }
        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* New Page Styles */
        .builder-section {
            margin-bottom: 30px;
        }
        
        .layout-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .layout-btn {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .layout-btn:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .layout-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .customize-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        
        .builder-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .tag-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tag-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tag-btn:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .tag-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .analytics-card {
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .analytics-chart {
            height: 200px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .heatmap-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            height: 200px;
        }
        
        .heatmap-cell {
            background: #e5e7eb;
            border-radius: 2px;
            transition: background 0.3s ease;
        }
        
        .heatmap-cell:hover {
            background: var(--primary);
        }
        
        .suggestions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .suggestion-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .toggle-slider {
            width: 50px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s ease;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
        }
        
        input[type="checkbox"]:checked + .toggle-slider {
            background: var(--primary);
        }
        
        input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(26px);
        }
        
        .current-plan {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: #f8fafc;
        }
        
        .plan-info h4 {
            margin: 0 0 5px 0;
            color: var(--primary);
        }
        
        .plan-info p {
            margin: 5px 0;
            color: #6b7280;
        }
        
        .plan-actions {
            display: flex;
            gap: 10px;
        }
        
        .payment-method {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .payment-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .payment-info i {
            font-size: 24px;
            color: var(--primary);
        }
        
        .expiry {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .invoice-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .invoice-date {
            font-weight: 500;
        }
        
        .invoice-amount {
            font-weight: 600;
            color: var(--primary);
        }
        
        .invoice-status {
            padding: 4px 8px;
            background: #10b981;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        /* Product Library Button States */
        .product-filter-btn.active,
        .product-sort-btn.active,
        .product-tag-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .product-filter-btn.active:hover,
        .product-sort-btn.active:hover,
        .product-tag-btn.active:hover {
            background: var(--primary-dark);
        }
        
        /* Custom Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification.info {
            border-left-color: var(--primary);
        }
        
        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            color: var(--danger);
        }
        
        .notification.warning .notification-icon {
            color: var(--warning);
        }
        
        .notification.info .notification-icon {
            color: var(--primary);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            color: var(--dark);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }
        
        .generated-content {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 100px;
        }
        
        /* Enhanced Dashboard Styles */
        .dashboard-overview {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .time-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-filter select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
        }
        
        .stat-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .stat-change {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .stat-change.positive {
            color: #10b981;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        .top-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .block-info h4 {
            margin: 0 0 5px 0;
            color: var(--primary);
        }
        
        .block-info p {
            margin: 0 0 10px 0;
            color: #6b7280;
        }
        
        .block-stats {
            display: flex;
            gap: 15px;
        }
        
        .block-stats .stat {
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .block-preview {
            flex-shrink: 0;
        }
        
        .preview-placeholder {
            width: 200px;
            height: 120px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .preview-placeholder i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .action-btn i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .action-btn span {
            font-weight: 500;
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        
        .activity-content p {
            margin: 0 0 5px 0;
            font-weight: 500;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* Enhanced SmartBlock Builder Styles */
        .builder-container {
            margin-top: 20px;
        }
        
        .builder-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .step.active {
            background: var(--primary);
            color: white;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .step.active .step-number {
            background: white;
            color: var(--primary);
        }
        
        .step-label {
            font-weight: 500;
        }
        
        .builder-step {
            display: none;
        }
        
        .builder-step.active {
            display: block;
        }
        
        .layout-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .layout-option {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .layout-option:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .layout-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .layout-preview {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .layout-option.selected .layout-preview {
            background: white;
            color: var(--primary);
        }
        
        .layout-option h4 {
            margin: 0 0 5px 0;
        }
        
        .layout-option p {
            margin: 0;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .layout-option.selected p {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .product-sources {
            margin-bottom: 30px;
        }
        
        .source-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .product-search input {
            flex: 1;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .selected-products {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .customize-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .customize-section {
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .customize-section h4 {
            margin: 0 0 20px 0;
            color: var(--primary);
        }
        
        .preview-container {
            margin-bottom: 30px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .preview-controls {
            display: flex;
            gap: 5px;
        }
        
        .preview-content {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: white;
            min-height: 300px;
        }
        
        .embed-section {
            margin-bottom: 30px;
        }
        
        .embed-code {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .embed-code textarea {
            flex: 1;
            height: 80px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .builder-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Enhanced Product Library Styles */
        .product-library-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-options {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .price-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .price-range input {
            flex: 1;
        }
        
        .rating-filter {
            display: flex;
            gap: 5px;
        }
        
        .rating-btn {
            padding: 5px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rating-btn:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .search-section {
            margin-top: 20px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
        }
        
        .search-bar input {
            flex: 1;
        }
        
        .tag-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .tag-group h4 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .tag-group .tag-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .tag-btn:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .tag-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .view-controls {
            display: flex;
            gap: 5px;
        }
        
        .view-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .view-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .products-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
        }
        
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .product-image {
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .product-card:hover .product-overlay {
            opacity: 1;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-info h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .product-brand {
            margin: 0 0 10px 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .price {
            font-weight: 600;
            color: var(--primary);
        }
        
        .rating {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .product-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .product-stats .stat {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .product-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .product-tags .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .tag.top-pick {
            background: #fef3c7;
            color: #92400e;
        }
        
        .tag.trending {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .tag.best-seller {
            background: #d1fae5;
            color: #065f46;
        }
        
        .tag.on-sale {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .tag.new-arrival {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .product-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .product-card:hover .product-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-btn {
            width: 35px;
            height: 35px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .ellipsis {
            padding: 0 10px;
            color: #6b7280;
        }
        
        /* Enhanced AI Assistant Styles */
        .ai-assistant-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .ai-tools-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .ai-tool-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-tool-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .ai-tool-section {
            display: none;
        }
        
        .ai-tool-section.active {
            display: block;
        }
        
        .content-generator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .generator-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .content-type-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-option:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
        }
        
        .generated-content-display {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .content-actions {
            display: flex;
            gap: 10px;
        }
        
        .analysis-tools,
        .seo-tools,
        .optimization-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .tool-card {
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .tool-card h4 {
            margin: 0 0 15px 0;
            color: var(--primary);
        }
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            width: calc(100% - 250px);
            box-sizing: border-box;
        }
        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }
        
        /* Page Content */
        .page-content {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure cards and content use full width */
        .page-content .card {
            width: 100%;
            box-sizing: border-box;
        }
        
        .page-content .stats-grid {
            width: 100%;
            box-sizing: border-box;
        }
        
        .page-content .table-container {
            width: 100%;
            overflow-x: auto;
        }
        
        /* Inline Toggle Button (shown when sidebar is hidden) */
        .inline-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
            font-size: 0.9rem;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
        }
        .inline-toggle-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .inline-toggle-btn:active {
            transform: scale(0.95);
        }
        
        /* Floating Toggle Button (always visible when sidebar is hidden) */
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }
        .page-title {
            font-size: 1.8rem;
            color: var(--dark);
        }
        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.5rem;
            color: white;
        }
        .stat-primary {
            background: var(--primary);
        }
        .stat-success {
            background: var(--success);
        }
        .stat-warning {
            background: var(--warning);
        }
        .stat-info {
            background: var(--info, #3b82f6);
        }
        .stat-danger {
            background: var(--danger);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-value.hidden {
            filter: blur(8px);
            user-select: none;
        }
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Global sensitive data toggle button */
        #globalSensitiveToggle, #globalSensitiveToggleAnalytics {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        #globalSensitiveToggle:hover, #globalSensitiveToggleAnalytics:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #globalSensitiveToggle i, #globalSensitiveToggleAnalytics i {
            font-size: 1rem;
        }
        /* Blocks Grid */
        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .block-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .block-card:hover {
            transform: translateY(-5px);
        }
        .block-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .block-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        .block-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-active {
            background: #dcfce7;
            color: #16a34a;
        }
        .status-draft {
            background: #fef3c7;
            color: #d97706;
        }
        .block-body {
            padding: 20px;
        }
        .block-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .block-meta span {
            color: var(--gray);
        }
        .block-actions {
            display: flex;
            gap: 10px;
        }
        .block-btn {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            text-align: center;
        }
        .btn-edit {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .btn-publish {
            background: #dcfce7;
            color: #16a34a;
        }
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f5f7fa;
            font-weight: 600;
            color: var(--dark);
        }
        tr:hover {
            background: #f9fafb;
        }
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        .alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .product-card {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        .product-card.selected {
            border-color: var(--primary);
            background: #dbeafe;
        }
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .product-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .product-price {
            font-weight: 700;
            color: var(--primary);
        }
        .product-retailer {
            font-size: 0.8rem;
            color: var(--gray);
        }
        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--gray);
        }
        .close:hover {
            color: var(--dark);
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1001;
                transform: translateX(-100%);
            }
            .sidebar:not(.hidden) {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 10px;
                width: 100%;
            }
            .main-content.expanded {
                margin-left: 0;
                width: 100%;
            }
            .sidebar-header {
                padding: 15px 15px 0;
            }
            .sidebar-toggle-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .inline-toggle-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                margin-right: 10px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .blocks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="images/IMG_4258.png" alt="KotaPal Logo" style="height: 40px; width: auto; max-width: 150px; object-fit: contain; margin-right: 10px; display: block;" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <div class="logo-text" style="font-weight:700;font-size:1.5rem;color:var(--dark);display:none;">KOTA PAL</div>
                </div>
                <button id="sidebarToggle" class="sidebar-toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="user-info">
                <div style="display: flex; align-items: center;">
                    <img id="sidebarUserAvatar" src="https://i.pravatar.cc/40?img=1" alt="User" class="user-avatar" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Ccircle cx=%2220%22 cy=%2220%22 r=%2220%22 fill=%22%233b82f6%22/%3E%3Ctext x=%2220%22 y=%2226%22 font-size=%2216%22 fill=%22white%22 text-anchor=%22middle%22 font-weight=%22bold%22%3EU%3C/text%3E%3C/svg%3E';">
                    <div>
                        <div class="user-name">Loading...</div>
                        <div class="user-plan">Loading...</div>
                    </div>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="blocks">
                        <i class="fas fa-cubes"></i>
                        SmartBlocks
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="products">
                        <i class="fas fa-box"></i>
                        Product Library
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="ai-assistant">
                        <i class="fas fa-robot"></i>
                        AI Assistant
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="analytics">
                        <i class="fas fa-chart-line"></i>
                        Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="billing">
                        <i class="fas fa-credit-card"></i>
                        Billing
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </li>
            </ul>
        </div>


        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page-content">
                <div class="header">
                    <div style="display: flex; align-items: center;">
                        <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">Dashboard</h1>
                            <div id="planInfo" style="margin-top: 5px; font-size: 0.9rem; color: var(--gray);"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="createBlockBtn">Create New Block</button>
                </div>

                <!-- Global Toggle for Sensitive Data -->
                <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                    <button id="globalSensitiveToggle" class="btn btn-secondary" onclick="toggleAllSensitive()" style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye-slash"></i>
                        <span>Show Sensitive Data</span>
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-primary">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                        <div class="stat-value" id="totalClicks" data-sensitive="true">0</div>
                        <div class="stat-label">Total Clicks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="estimatedRevenue" data-sensitive="true">$0.00</div>
                        <div class="stat-label">Estimated Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-warning">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-value" id="avgCTR" data-sensitive="true">0%</div>
                        <div class="stat-label">Average CTR</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-info">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <div class="stat-value" id="totalBlocks" data-sensitive="true">0</div>
                        <div class="stat-label">Total Blocks</div>
                    </div>
                </div>
            </div>

            <!-- Blocks Page -->
            <div id="blocks-page" class="page-content" style="display: none;">
                <div class="header">
                    <div style="display: flex; align-items: center;">
                        <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title">SmartBlocks</h1>
                    </div>
                    <button class="btn btn-primary" id="newBlockBtn">Create New Block</button>
                </div>
                
                <!-- SmartBlock Builder Quick Actions -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title" style="margin-bottom:12px;display:flex;align-items:center;gap:8px;"><i class="fas fa-cubes" style="color:#0ea5e9;"></i> SmartBlock Builder</h3>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
                            <button class="btn btn-primary" id="sbCreateBlockBtn">Create New Block</button>
                            <button class="btn btn-secondary" id="sbOpenLibraryBtn">Open Product Library</button>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600; margin-bottom:8px;">Choose Layout</div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-secondary sb-layout" data-layout="table">Table</button>
                                <button class="btn btn-secondary sb-layout" data-layout="carousel">Carousel</button>
                                <button class="btn btn-secondary sb-layout" data-layout="callout">Callout</button>
                                <button class="btn btn-secondary sb-layout" data-layout="roundup">Roundup</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
                            <button class="btn btn-secondary" id="sbAddAffiliateBtn">Add Affiliate Product</button>
                            <button class="btn btn-secondary" id="sbAddShopifyBtn">Add Shopify Product</button>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600; margin-bottom:8px;">Customize</div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-secondary" id="sbCustomizeColorsBtn">Colors</button>
                                <button class="btn btn-secondary" id="sbCustomizeHeadlineBtn">Headline</button>
                                <button class="btn btn-secondary" id="sbCustomizeCtaBtn">Button Text</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-secondary" id="sbPreviewBtn">Preview</button>
                            <button class="btn btn-secondary" id="sbGenerateEmbedBtn">Generate Embed Code</button>
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- New Block Page -->
            <div id="new-block-page" class="page-content" style="display: none;">
                <div class="header">
                    <div style="display: flex; align-items: center;">
                        <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title">Create New SmartBlock</h1>
                    </div>
                    <button class="btn btn-secondary" id="backToBlocksBtn">Back to Blocks</button>
                </div>
                
                <!-- Product Library: Requested feature list -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title" style="margin-bottom:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-box-open" style="color:#10b981;"></i> Product Library</h3>
                        <ul style="margin-left:18px;color:#374151;line-height:1.8;">
                            <li>Filter by: Source (Shopify, Amazon, Walmart)</li>
                            <li>Sort by: Price, Clicks, Rating</li>
                            <li>Add new product</li>
                            <li>Tag: [Top Pick] [On Sale] [Low Stock]</li>
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <form id="newBlockForm">
                        <div class="form-group">
                            <label for="blockTitle">Block Title</label>
                            <input type="text" id="blockTitle" class="form-control" placeholder="e.g., Best Headphones Under $300" required>
                        </div>
                        <div class="form-group">
                            <label>Layout</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn btn-secondary layout-btn active" data-layout="grid">Grid</button>
                                <button type="button" class="btn btn-secondary layout-btn" data-layout="carousel">Carousel</button>
                                <button type="button" class="btn btn-secondary layout-btn" data-layout="single">Single</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ctaText">Call to Action Text</label>
                            <input type="text" id="ctaText" class="form-control" placeholder="e.g., Buy Now, Check Price, Learn More" value="Buy Now" required>
                        </div>
                        <div class="form-group">
                            <label>Select Retailer</label>
                            <select id="retailerSelect" class="form-control">
                                <option value="">Select a retailer</option>
                                <option value="amazon">Amazon</option>
                                <option value="walmart">Walmart</option>
                                <option value="shopify">Shopify</option>
                                <option value="skimlinks">Skimlinks</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Search Products</label>
                            <input type="text" id="productSearch" class="form-control" placeholder="Search for products...">
                            <div id="searchStatus" style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);"></div>
                        </div>
                        <div id="productsContainer" class="product-grid">
                            <!-- Products will be loaded here -->
                        </div>
                        <div class="form-group">
                            <label>Selected Products (<span id="selectedCount">0</span>/10)</label>
                            <div id="selectedProducts" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <!-- Selected products will be displayed here -->
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button type="button" class="btn btn-secondary" id="cancelNewBlock">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Block</button>
                        </div>
                    </form>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="text-align: center; margin-bottom: 30px;">Login to KOTA PAL</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="••••••••" required>
                </div>
                <div style="text-align: center; margin: 20px 0;">
                    <a href="#" style="color: var(--primary); font-size: 0.9rem;">Forgot Password?</a>
                </div>
                <button type="submit" class="btn btn-primary" id="loginSubmit" style="width: 100%;">Login</button>
                <div id="loginStatus" style="margin-top:10px;font-size:0.9rem;color:var(--gray);"></div>
            </form>
            <div style="text-align: center; margin-top: 20px;">
                <p>Don't have an account? <a href="#" id="showSignup">Sign Up</a></p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="text-align: center; margin-bottom: 30px;">Create Account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" class="form-control" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-control" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-control" placeholder="••••••••" required>
                </div>
                <div class="form-group">
                    <label for="signupWebsite">Website/Blog URL (Optional)</label>
                    <input type="url" id="signupWebsite" class="form-control" placeholder="https://yourwebsite.com">
                </div>
                <div class="form-group">
                    <label for="signupPlan">Select Plan</label>
                    <select id="signupPlan" class="form-control">
                        <option value="starter">Starter (Free)</option>
                        <option value="pro">Pro ($19/month)</option>
                        <option value="creatorplus">Creator+ ($49/month)</option>
                    </select>
                    <div id="planCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px;">
                        <div class="card plan-card" data-plan="starter" style="cursor:pointer;border:2px solid #e5e7eb;">
                            <div style="padding:12px;">
                                <div style="font-weight:700;">Starter</div>
                                <div class="stat-label">Free • Basic features</div>
                            </div>
                        </div>
                        <div class="card plan-card" data-plan="pro" style="cursor:pointer;border:2px solid #e5e7eb;">
                            <div style="padding:12px;">
                                <div style="font-weight:700;">Pro</div>
                                <div class="stat-label">$19/mo • Analytics & more</div>
                            </div>
                        </div>
                        <div class="card plan-card" data-plan="creatorplus" style="cursor:pointer;border:2px solid #e5e7eb;">
                            <div style="padding:12px;">
                                <div style="font-weight:700;">Creator+</div>
                                <div class="stat-label">$49/mo • Unlimited, SmartAlerts</div>
                            </div>
                        </div>
                        <div class="card plan-card" data-plan="agency" style="cursor:pointer;border:2px solid #e5e7eb;">
                            <div style="padding:12px;">
                                <div style="font-weight:700;">Agency</div>
                                <div class="stat-label">$199/mo • White-label, Multi-client</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="font-size: 0.9rem; color: var(--gray); margin: 15px 0;">
                    By signing up, you agree to our <a href="#" style="color: var(--primary);">Terms of Service</a> and <a href="#" style="color: var(--primary);">Privacy Policy</a>.
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                <div id="signupStatus" style="margin-top:10px;font-size:0.9rem;color:var(--gray);"></div>
            </form>
            <div style="text-align: center; margin-top: 20px;">
                <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Product Library Page -->
    <div id="products-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Product Library</h1>
            </div>
            <button class="btn btn-primary" id="addNewProductBtn">Add New Product</button>
        </div>
        
        <!-- Filters and Sort -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Filters & Sort</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Filter by Source:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary product-filter-btn active" data-filter="all">All</button>
                        <button class="btn btn-secondary product-filter-btn" data-filter="shopify">Shopify</button>
                        <button class="btn btn-secondary product-filter-btn" data-filter="amazon">Amazon</button>
                        <button class="btn btn-secondary product-filter-btn" data-filter="walmart">Walmart</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Sort by:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary product-sort-btn" data-sort="price">Price</button>
                        <button class="btn btn-secondary product-sort-btn" data-sort="clicks">Clicks</button>
                        <button class="btn btn-secondary product-sort-btn" data-sort="rating">Rating</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Tags:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary product-tag-btn" data-tag="top-pick">Top Pick</button>
                        <button class="btn btn-secondary product-tag-btn" data-tag="on-sale">On Sale</button>
                        <button class="btn btn-secondary product-tag-btn" data-tag="low-stock">Low Stock</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products Display Container -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Products</h3>
            </div>
            <div id="productsLibraryContainer" class="card-body">
                <p style="color: var(--gray); text-align: center; padding: 40px;">No products found. Click "Add New Product" to get started.</p>
            </div>
        </div>
    </div>

    <!-- AI Assistant Page -->
    <div id="ai-assistant-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">AI Assistant</h1>
            </div>
        </div>

        <!-- AI Features Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <!-- Feature 1: Generate Product Blurbs -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-file-alt" style="color: #3b82f6;"></i> Generate Product Blurbs</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Name *</label>
                        <input type="text" id="blurbProductName" placeholder="e.g., Wireless Earbuds Pro" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Details (Optional)</label>
                        <textarea id="blurbProductDetails" placeholder="Add key features, specs..." rows="3"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tone</label>
                        <select id="blurbTone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="professional">Professional</option>
                            <option value="casual">Casual</option>
                            <option value="friendly">Friendly</option>
                            <option value="persuasive">Persuasive</option>
                        </select>
                    </div>
                    <button onclick="generateBlurb()" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-magic"></i> Generate Blurb
                    </button>
                    <div id="blurbResult" style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 4px; display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Generated Blurb</strong>
                            <button onclick="copyToClipboard('blurbResultContent')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <p id="blurbResultContent" style="white-space: pre-wrap; color: #333;"></p>
                    </div>
                </div>
            </div>

            <!-- Feature 2: Auto-Write Pros & Cons -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-lightbulb" style="color: #10b981;"></i> Auto-Write Pros & Cons</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Name *</label>
                        <input type="text" id="prosConsProductName" placeholder="e.g., Bluetooth Speaker" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Details (Optional)</label>
                        <textarea id="prosConsProductDetails" placeholder="Add features, specifications..." rows="3"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <button onclick="generateProsCons()" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-list"></i> Generate Pros & Cons
                    </button>
                    <div id="prosConsResult" style="margin-top: 15px; display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 10px; background: #d1fae5; border-radius: 4px;">
                                <strong style="color: #059669;">✓ Pros</strong>
                                <ul id="prosList" style="margin-top: 10px; color: #333;"></ul>
                            </div>
                            <div style="padding: 10px; background: #fee2e2; border-radius: 4px;">
                                <strong style="color: #dc2626;">✗ Cons</strong>
                                <ul id="consList" style="margin-top: 10px; color: #333;"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature 3: Suggest Product Alternatives -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-search" style="color: #f59e0b;"></i> Suggest Product Alternatives</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Current Product *</label>
                        <input type="text" id="alternativeProductName" placeholder="e.g., iPhone 15" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Budget (Optional)</label>
                        <input type="text" id="alternativeBudget" placeholder="e.g., Under $500" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <button onclick="suggestAlternatives()" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-lightbulb"></i> Suggest Alternatives
                    </button>
                    <div id="alternativesResult" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>

            <!-- Feature 4: AI FAQ Builder -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-question-circle" style="color: #ec4899;"></i> AI FAQ Builder (SEO)</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Name *</label>
                        <input type="text" id="faqProductName" placeholder="e.g., Smart Watch" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Details (Optional)</label>
                        <textarea id="faqProductDetails" placeholder="Add product information..." rows="2"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Number of FAQs</label>
                        <select id="faqCount" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="5">5 Questions</option>
                            <option value="7">7 Questions</option>
                            <option value="10">10 Questions</option>
                        </select>
                    </div>
                    <button onclick="generateFAQ()" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-file-question"></i> Generate FAQ
                    </button>
                    <div id="faqResult" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations Page -->
    <div id="integrations-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Integrations</h1>
            </div>
        </div>
        <div id="integrationsContainer"><!-- Integrations will be loaded here --></div>
    </div>

    <!-- Analytics Page -->
    <div id="analytics-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Analytics</h1>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <select id="dateRangeFilter" class="form-control" style="max-width:200px;">
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="ytd">Year to date</option>
                        <option value="all">All time</option>
                    </select>
                    <select id="retailerFilter" class="form-control" style="max-width:200px;">
                        <option value="all">All Retailers</option>
                        <option value="amazon">Amazon</option>
                        <option value="walmart">Walmart</option>
                        <option value="shopify">Shopify</option>
                        <option value="skimlinks">Skimlinks</option>
                    </select>
                </div>
                <!-- Global Toggle for Sensitive Data -->
                <div style="display: flex; justify-content: center; margin-top: 15px; margin-bottom: 15px;">
                    <button id="globalSensitiveToggleAnalytics" class="btn btn-secondary" onclick="toggleAllSensitive()" style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye-slash"></i>
                        <span>Show Sensitive Data</span>
                    </button>
                </div>
                <div class="stats-grid" style="margin-top:15px;">
                    <div class="stat-card">
                        <div class="stat-icon stat-primary"><i class="fas fa-mouse-pointer"></i></div>
                        <div class="stat-value" id="filteredClicks" data-sensitive="true">0</div>
                        <div class="stat-label">Clicks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-success"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-value" id="filteredRevenue" data-sensitive="true">$0.00</div>
                        <div class="stat-label">Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-warning"><i class="fas fa-percentage"></i></div>
                        <div class="stat-value" id="filteredCTR" data-sensitive="true">0%</div>
                        <div class="stat-label">CTR</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-info"><i class="fas fa-cubes"></i></div>
                        <div class="stat-value" id="blocksShowing">0</div>
                        <div class="stat-label">Blocks Showing</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Block Performance</h3></div>
            <div class="table-container">
                <table id="analyticsTable">
                    <thead>
                        <tr>
                            <th>Block Name</th>
                            <th>Layout</th>
                            <th>Clicks</th>
                            <th>CTR</th>
                            <th>Revenue</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Recent Activity</h3></div>
            <div class="table-container">
                <table id="activityTable">
                    <thead>
                        <tr>
                            <th>Block Name</th>
                            <th>Layout</th>
                            <th>Clicks</th>
                            <th>Revenue</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Performance Alerts</h3></div>
            <div id="alertsContainer"></div>
        </div>
        <div id="performanceDataContainer"></div>
    </div>

    <!-- Account Page -->
    <div id="account-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Account Settings</h1>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Profile</h3></div>
            <form id="profileForm">
                <div class="form-group">
                    <label for="userName">Name</label>
                    <input type="text" id="userName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userWebsite">Website/Blog URL</label>
                    <input type="url" id="userWebsite" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Billing & Subscription</h3></div>
            <div id="billingPlansContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; grid-auto-flow: row;"></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">API & Embed</h3></div>
            <div class="form-group">
                <label>Universal Embed Script</label>
                <p style="margin: 10px 0; color: var(--gray);">Copy and paste this script to embed your SmartBlocks anywhere:</p>
                <div style="background: #1a1a1a; color: #4ade80; padding: 15px; border-radius: 8px; font-family: monospace; overflow-x: auto;">
                    <script async src="https://kota.example.com/embed.js" data-block-id="BLOCK_ID"></script>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Settings</h1>
            </div>
        </div>
        
        <!-- Profile Settings -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Profile Settings</h3>
            </div>
            <form id="settingsProfileForm">
                <div class="form-group">
                    <label for="userNameSettings">Name</label>
                    <input type="text" id="userNameSettings" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userEmailSettings">Email</label>
                    <input type="email" id="userEmailSettings" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userWebsiteSettings">Website/Blog URL</label>
                    <input type="url" id="userWebsiteSettings" class="form-control">
                </div>
                <div class="form-group">
                    <label>Profile Picture</label>
                    <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
                        <img id="settingsAvatarPreview" src="https://i.pravatar.cc/80?img=1" alt="Profile preview" class="user-avatar" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #e5e7eb;" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Ccircle cx=%2230%22 cy=%2230%22 r=%2230%22 fill=%22%233b82f6%22/%3E%3Ctext x=%2230%22 y=%2238%22 font-size=%2224%22 fill=%22white%22 text-anchor=%22middle%22 font-weight=%22bold%22%3EU%3C/text%3E%3C/svg%3E';">
                        <div style="flex:1;min-width:220px;">
                            <input type="url" id="userAvatarUrlSettings" class="form-control" placeholder="https://your-cdn.com/avatar.jpg or data:image/...">
                            <small style="color:var(--gray);font-size:0.85rem;">Paste an image URL or a data URL. This picture will appear in the sidebar.</small>
                        </div>
                        <div style="flex-basis:100%;margin-top:10px;">
                            <input type="file" id="userAvatarFileSettings" accept="image/*" class="form-control">
                            <small style="color:var(--gray);font-size:0.85rem;">Or upload a picture (stored in your browser and, where supported, in your profile).</small>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Profile</button>
                <div id="settingsProfileStatus" style="margin-top:10px;font-size:0.9rem;color:var(--gray);"></div>
            </form>
        </div>
        
        <!-- Change Password -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Change Password</h3>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="••••••••" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="••••••••" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-primary">Update Password</button>
                <div id="passwordStatus" style="margin-top:10px;font-size:0.9rem;color:var(--gray);"></div>
            </form>
        </div>

        <!-- Affiliate API Keys -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Affiliate API Keys</h3>
                <p style="font-size:0.9rem;color:var(--gray);margin:0;">Connect your affiliate accounts to access products and display top performing items</p>
            </div>
            <form id="affiliateKeysForm">
                <div class="form-group">
                    <label for="amazonApiKey">
                        <i class="fab fa-amazon" style="color:#FF9900;margin-right:8px;"></i>
                        Amazon Associates API Key / Access Key
                    </label>
                    <input type="text" id="amazonApiKey" class="form-control" placeholder="Enter your Amazon Associates API key">
                    <small style="color:var(--gray);font-size:0.85rem;">Used to access Amazon product data and track top performers</small>
                </div>
                <div class="form-group">
                    <label for="amazonSecretKey">Amazon Secret Key</label>
                    <input type="password" id="amazonSecretKey" class="form-control" placeholder="Enter your Amazon Secret Key">
                    <small style="color:var(--gray);font-size:0.85rem;">Your Amazon Associates Secret Access Key</small>
                </div>
                <div class="form-group">
                    <label for="amazonAssociateTag">Amazon Associate Tag</label>
                    <input type="text" id="amazonAssociateTag" class="form-control" placeholder="yourname-20">
                    <small style="color:var(--gray);font-size:0.85rem;">Your Amazon Associates tracking ID</small>
                </div>
                <div class="form-group">
                    <label for="amazonSiteStripeLink">Amazon SiteStripe Link</label>
                    <input type="url" id="amazonSiteStripeLink" class="form-control" placeholder="https://amzn.to/your-link" autocomplete="off">
                    <small style="color:var(--gray);font-size:0.85rem;">Paste a SiteStripe link (e.g., https://amzn.to/4oFQS2S) to import products directly into your Product Library.</small>
                    <button type="button" class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="importSiteStripeFromSettings()">
                        <i class="fas fa-link"></i> Import from SiteStripe
                    </button>
                </div>

                <div class="form-group" style="margin-top:30px;padding-top:30px;border-top:1px solid #e5e7eb;">
                    <label for="walmartApiKey">
                        <i class="fas fa-shopping-bag" style="color:#0071ce;margin-right:8px;"></i>
                        Walmart Impact API Key
                    </label>
                    <input type="text" id="walmartApiKey" class="form-control" placeholder="Enter your Walmart Impact API key">
                    <small style="color:var(--gray);font-size:0.85rem;">Used to access Walmart product data and performance metrics</small>
                </div>
                <div class="form-group">
                    <label for="walmartImpactId">Walmart Impact ID</label>
                    <input type="text" id="walmartImpactId" class="form-control" placeholder="Enter your Impact ID">
                    <small style="color:var(--gray);font-size:0.85rem;">Your Walmart Impact Radius Publisher ID</small>
                </div>

                <div class="form-group" style="margin-top:30px;padding-top:30px;border-top:1px solid #e5e7eb;">
                    <label for="shopifyApiKey">
                        <i class="fab fa-shopify" style="color:#95BF47;margin-right:8px;"></i>
                        Shopify API Key
                    </label>
                    <input type="text" id="shopifyApiKey" class="form-control" placeholder="Enter your Shopify API key">
                    <small style="color:var(--gray);font-size:0.85rem;">Used to access your Shopify store products and sales data</small>
                </div>
                <div class="form-group">
                    <label for="shopifyStoreUrl">Shopify Store URL</label>
                    <input type="text" id="shopifyStoreUrl" class="form-control" placeholder="yourstore.myshopify.com">
                    <small style="color:var(--gray);font-size:0.85rem;">Your Shopify store domain</small>
                </div>
                <div class="form-group">
                    <label for="shopifySecretKey">Shopify Secret Key</label>
                    <input type="password" id="shopifySecretKey" class="form-control" placeholder="Enter your Shopify Secret Key">
                    <small style="color:var(--gray);font-size:0.85rem;">Your Shopify API Secret Key</small>
                </div>

                <div class="form-group" style="margin-top:30px;padding-top:30px;border-top:1px solid #e5e7eb;">
                    <label for="skimlinksApiKey">
                        <i class="fas fa-link" style="color:#6366f1;margin-right:8px;"></i>
                        Skimlinks API Key
                    </label>
                    <input type="text" id="skimlinksApiKey" class="form-control" placeholder="Enter your Skimlinks API key">
                    <small style="color:var(--gray);font-size:0.85rem;">Used to access Skimlinks merchant products and performance data</small>
                </div>

                <button type="submit" class="btn btn-primary">Save API Keys</button>
                <div id="apiKeysStatus" style="margin-top:10px;font-size:0.9rem;color:var(--gray);"></div>
            </form>
        </div>

        <!-- Top Performing Products (using API Keys) -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Top Performing Products</h3>
                <p style="font-size:0.9rem;color:var(--gray);margin:0;">Products fetched from your connected affiliate accounts</p>
            </div>
            <div id="topProductsContainer" class="card-body">
                <p style="color:var(--gray);text-align:center;padding:20px;">Connect your API keys above to see top performing products</p>
            </div>
        </div>
    </div>

    <!-- Billing Page -->
    <div id="billing-page" class="page-content" style="display: none;">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="inlineToggle" class="inline-toggle-btn" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Billing</h1>
            </div>
        </div>
        
        <!-- Current Plan and Plan Actions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Plans</h3>
            </div>
            <div id="billingPlansContainerBilling" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 10px; grid-auto-flow: row;"></div>
        </div>
        
        <!-- Billing History -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Billing History</h3>
            </div>
            <div class="invoice-list" id="billingHistory">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>


    <script>
        // (AI calls will be routed through backend API; no user API key required)

        // DOM Elements
        const currentPage = document.getElementById('dashboard-page');
        const blocksPage = document.getElementById('blocks-page');
        const newBlockPage = document.getElementById('new-block-page');
        const integrationsPage = document.getElementById('integrations-page');
        const analyticsPage = document.getElementById('analytics-page');
        const accountPage = document.getElementById('account-page');
        const productsPage = document.getElementById('products-page');
        const aiAssistantPage = document.getElementById('ai-assistant-page');
        const settingsPage = document.getElementById('settings-page');
        const billingPage = document.getElementById('billing-page');
        
        const navLinks = document.querySelectorAll('.nav-link');
        const createBlockBtn = document.getElementById('createBlockBtn');
        const newBlockBtn = document.getElementById('newBlockBtn');
        const backToBlocksBtn = document.getElementById('backToBlocksBtn');
        const cancelNewBlock = document.getElementById('cancelNewBlock');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const closeBtns = document.querySelectorAll('.close');
        const showLogin = document.getElementById('showLogin');
        const showSignup = document.getElementById('showSignup');
        
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const profileForm = document.getElementById('profileForm');
        const newBlockForm = document.getElementById('newBlockForm');
        const copyApiKey = document.getElementById('copyApiKey');
        
        const retailerSelect = document.getElementById('retailerSelect');
        const productSearch = document.getElementById('productSearch');
        const searchStatus = document.getElementById('searchStatus');
        const productsContainer = document.getElementById('productsContainer');
        const selectedProducts = document.getElementById('selectedProducts');
        const selectedCount = document.getElementById('selectedCount');
        
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const retailerFilter = document.getElementById('retailerFilter');

        // State
        let API_BASE = '';
        let ALT_BASE = 'http://127.0.0.1:3000';
        let authToken = localStorage.getItem('kotaToken') || null;
        let currentUser = null;
        let currentBlocks = [];
        let currentIntegrations = [];
        let selectedProductsList = [];
        let currentLayout = 'grid';
        let userLocation = { country: null, countryCode: null, region: null, city: null, ip: null, timezone: null };

        async function apiRequest(path, { method = 'GET', body } = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 8000);
            try {
                let res = await fetch(API_BASE + path, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : undefined,
                    signal: controller.signal
                });
                if (!res.ok && (res.status === 0 || res.type === 'opaque')) {
                    // retry against ALT_BASE
                    res = await fetch(ALT_BASE + path, { method, headers, body: body ? JSON.stringify(body) : undefined, signal: controller.signal });
                }
                if (res.status === 401) {
                    localStorage.removeItem('kotaToken');
                    localStorage.removeItem('kotaUser');
                    authToken = null;
                    showLoginModal();
                    throw new Error('Unauthorized');
                }
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `HTTP ${res.status}`);
                }
                return await res.json();
            } catch (e) {
                // Offline fallback: return minimal mock for critical endpoints
                const msg = e.message === 'The user aborted a request.' ? 'Network timeout contacting API' : (e.message || 'Network error');
                if (path === '/api/user/profile') {
                    const saved = localStorage.getItem('kotaUser');
                    if (saved) return JSON.parse(saved);
                }
                if (path.startsWith('/api/blocks') && method === 'GET') {
                    return [];
                }
                if (path.startsWith('/api/integrations') && method === 'GET') {
                    return [];
                }
                if (path.startsWith('/api/analytics')) {
                    return { totalClicks: 0, totalRevenue: 0, avgCTR: 0, blocksCount: 0, topBlock: '', topProduct: '' };
                }
                if (path.startsWith('/api/alerts')) {
                    return [];
                }
                throw new Error(msg + ` — API: ${API_BASE} or ${ALT_BASE}`);
            } finally {
                clearTimeout(timeout);
            }
        }

        // Populate settings profile form with current user data
        function populateSettingsForm() {
            if (!currentUser) {
                console.warn('⚠️ populateSettingsForm: currentUser is null');
                // Try to load from localStorage as fallback
                const saved = localStorage.getItem('kotaUser');
                if (saved) {
                    try {
                        currentUser = JSON.parse(saved);
                        console.log('✅ Loaded currentUser from localStorage:', currentUser);
                    } catch (e) {
                        console.error('❌ Failed to parse saved user:', e);
                        return;
                    }
                } else {
                    return;
                }
            }
            
            console.log('🔄 populateSettingsForm called with:', currentUser);
            
            const n = document.getElementById('userNameSettings');
            const e = document.getElementById('userEmailSettings');
            const w = document.getElementById('userWebsiteSettings');
            const avatarUrlInput = document.getElementById('userAvatarUrlSettings');
            const avatarPreview = document.getElementById('settingsAvatarPreview');
            
            if (n) {
                n.value = currentUser.name || '';
                console.log('✅ Set userNameSettings to:', currentUser.name);
            }
            if (e) {
                e.value = currentUser.email || '';
                console.log('✅ Set userEmailSettings to:', currentUser.email);
            }
            if (w) {
                w.value = currentUser.website || '';
                console.log('✅ Set userWebsiteSettings to:', currentUser.website);
            }
            if (avatarUrlInput) {
                avatarUrlInput.value = currentUser.avatarUrl || '';
                console.log('✅ Set userAvatarUrlSettings to:', currentUser.avatarUrl);
            }
            if (avatarPreview) {
                if (currentUser.avatarUrl) {
                    avatarPreview.src = currentUser.avatarUrl;
                } else {
                    // Fallback to default avatar
                    avatarPreview.src = 'https://i.pravatar.cc/80?img=1';
                }
            }
            
            // Populate API keys from user settings
            populateApiKeysForm();
            
            console.log('✅ populateSettingsForm completed');
        }
        
        // Populate API keys form with saved keys
        function populateApiKeysForm() {
            if (!currentUser) return;
            const apiKeys = currentUser.apiKeys || {};
            
            const amazonKey = document.getElementById('amazonApiKey');
            const amazonSecret = document.getElementById('amazonSecretKey');
            const amazonTag = document.getElementById('amazonAssociateTag');
            const amazonSiteStripe = document.getElementById('amazonSiteStripeLink');
            const walmartKey = document.getElementById('walmartApiKey');
            const walmartId = document.getElementById('walmartImpactId');
            const shopifyKey = document.getElementById('shopifyApiKey');
            const shopifyUrl = document.getElementById('shopifyStoreUrl');
            const shopifySecret = document.getElementById('shopifySecretKey');
            const skimlinksKey = document.getElementById('skimlinksApiKey');
            
            if (amazonKey) amazonKey.value = apiKeys.amazonApiKey || '';
            if (amazonSecret) amazonSecret.value = apiKeys.amazonSecretKey || '';
            if (amazonTag) amazonTag.value = apiKeys.amazonAssociateTag || '';
            if (amazonSiteStripe) amazonSiteStripe.value = apiKeys.amazonSiteStripeLink || '';
            if (walmartKey) walmartKey.value = apiKeys.walmartApiKey || '';
            if (walmartId) walmartId.value = apiKeys.walmartImpactId || '';
            if (shopifyKey) shopifyKey.value = apiKeys.shopifyApiKey || '';
            if (shopifyUrl) shopifyUrl.value = apiKeys.shopifyStoreUrl || '';
            if (shopifySecret) shopifySecret.value = apiKeys.shopifySecretKey || '';
            if (skimlinksKey) skimlinksKey.value = apiKeys.skimlinksApiKey || '';
        }
        
        // Handle affiliate API keys form submission
        async function handleAffiliateKeysSubmit(e) {
            e.preventDefault();
            const status = document.getElementById('apiKeysStatus');
            if (status) { status.style.color = 'var(--gray)'; status.textContent = 'Saving API keys...'; }
            
            const apiKeys = {
                amazonApiKey: document.getElementById('amazonApiKey')?.value || '',
                amazonSecretKey: document.getElementById('amazonSecretKey')?.value || '',
                amazonAssociateTag: document.getElementById('amazonAssociateTag')?.value || '',
                amazonSiteStripeLink: document.getElementById('amazonSiteStripeLink')?.value || '',
                walmartApiKey: document.getElementById('walmartApiKey')?.value || '',
                walmartImpactId: document.getElementById('walmartImpactId')?.value || '',
                shopifyApiKey: document.getElementById('shopifyApiKey')?.value || '',
                shopifyStoreUrl: document.getElementById('shopifyStoreUrl')?.value || '',
                shopifySecretKey: document.getElementById('shopifySecretKey')?.value || '',
                skimlinksApiKey: document.getElementById('skimlinksApiKey')?.value || ''
            };
            
            try {
                // Save to backend if available
                const updated = await apiRequest('/api/user/profile', { 
                    method: 'PUT', 
                    body: { apiKeys } 
                });
                currentUser = updated || { ...(currentUser || {}), apiKeys };
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                // Update user display in real-time
                
                updateUserDisplay();
                showNotification('API keys saved successfully!', 'success', 'Keys Saved');
                
                // Load top performing products after saving
                await loadTopPerformingProducts();
                
                // Import SiteStripe products if link provided
                if (apiKeys.amazonSiteStripeLink) {
                    await fetchSiteStripeProducts(apiKeys.amazonSiteStripeLink, apiKeys, status);
                }
                
                if (status) { status.style.color = '#065f46'; status.textContent = 'Saved'; }
            } catch (_) {
                // Offline fallback
                if (!currentUser) currentUser = {};
                currentUser.apiKeys = apiKeys;
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                // Update user display in real-time
                updateUserDisplay();
                showNotification('API keys saved (offline mode). Changes visible immediately.', 'warning', 'Keys Saved');
                await loadTopPerformingProducts();
                if (apiKeys.amazonSiteStripeLink) {
                    await fetchSiteStripeProducts(apiKeys.amazonSiteStripeLink, apiKeys, status);
                }
                if (status) { status.style.color = '#065f46'; status.textContent = 'Saved (offline)'; }
            }
        }
        
        // Load top performing products using API keys
        async function loadTopPerformingProducts() {
            const container = document.getElementById('topProductsContainer');
            if (!container) return;
            
            if (!currentUser || !currentUser.apiKeys) {
                container.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">Connect your API keys above to see top performing products</p>';
                return;
            }
            
            const apiKeys = currentUser.apiKeys;
            container.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">Loading top products...</p>';
            
            try {
                // Try to fetch from backend API with location data
                const products = await apiRequest('/api/products/top-performing', {
                    method: 'POST',
                    body: { 
                        apiKeys,
                        location: userLocation
                    }
                });
                
                if (products && products.length > 0) {
                    // Automatically add products to library
                    const added = (addProductsToLibrary(products.map(p => ({ ...p, source: 'api' }))) || 0);
                    if (added > 0) {
                        showNotification(`${added} top performing product(s) added to library`, 'success', 'Products Added');
                        if (document.getElementById('products-page')?.style.display !== 'none') {
                            renderProductsLibrary();
                        }
                    }
                    renderTopProducts(products);
                } else {
                    container.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">No top performing products found. Check your API keys and try again.</p>';
                }
            } catch (err) {
                // Fallback: show mock/demo products if API keys are set (region-specific)
                if (apiKeys.amazonApiKey || apiKeys.walmartApiKey || apiKeys.shopifyApiKey) {
                    const region = userLocation.countryCode || 'US';
                    const regionName = userLocation.country || 'United States';
                    
                    // Region-specific mock products
                    let mockProducts = [];
                    if (region === 'US' || region === 'CA') {
                        mockProducts = [
                            { title: 'Sony WH-1000XM5', retailer: 'amazon', price: 299.99, clicks: 1247, revenue: 89.42, image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=500&q=80', region: regionName },
                            { title: 'Bose QuietComfort 45', retailer: 'amazon', price: 279.99, clicks: 892, revenue: 67.85, image: 'https://images.unsplash.com/photo-1572536147248-ac59a8abfa4b?auto=format&fit=crop&w=500&q=80', region: regionName },
                            { title: 'Samsung 55" Crystal UHD', retailer: 'walmart', price: 499.99, clicks: 654, revenue: 52.30, image: 'https://images.unsplash.com/photo-1593305841991-05c297ba4575?auto=format&fit=crop&w=500&q=80', region: regionName }
                        ];
                    } else if (region === 'GB' || region === 'UK') {
                        mockProducts = [
                            { title: 'Sony WH-1000XM5', retailer: 'amazon', price: 249.99, clicks: 1123, revenue: 78.50, image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=500&q=80', region: regionName },
                            { title: 'Bose QuietComfort 45', retailer: 'amazon', price: 229.99, clicks: 856, revenue: 62.30, image: 'https://images.unsplash.com/photo-1572536147248-ac59a8abfa4b?auto=format&fit=crop&w=500&q=80', region: regionName }
                        ];
                    } else {
                        mockProducts = [
                            { title: 'Sony WH-1000XM5', retailer: 'amazon', price: 299.99, clicks: 1247, revenue: 89.42, image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=500&q=80', region: regionName },
                            { title: 'Bose QuietComfort 45', retailer: 'amazon', price: 279.99, clicks: 892, revenue: 67.85, image: 'https://images.unsplash.com/photo-1572536147248-ac59a8abfa4b?auto=format&fit=crop&w=500&q=80', region: regionName }
                        ];
                    }
                    // Automatically add mock products to library
                    const added = (addProductsToLibrary(mockProducts.map(p => ({ ...p, source: 'api' }))) || 0);
                    if (added > 0) {
                        const regionMsg = userLocation.country ? ` for ${userLocation.country}` : '';
                        showNotification(`${added} top performing product(s)${regionMsg} added to library`, 'success', 'Products Added');
                        if (document.getElementById('products-page')?.style.display !== 'none') {
                            renderProductsLibrary();
                        }
                    }
                    renderTopProducts(mockProducts);
                } else {
                    container.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">Connect your API keys above to see top performing products</p>';
                }
            }
        }
        
        // Render top performing products
        function renderTopProducts(products) {
            const container = document.getElementById('topProductsContainer');
            if (!container) return;
            
            if (products.length === 0) {
                container.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">No products found</p>';
                return;
            }
            
            // Show region info if available
            const regionInfo = userLocation.country ? `<div style="background:#f0f9ff;border-left:4px solid var(--primary);padding:12px 15px;margin-bottom:15px;border-radius:4px;"><p style="color:var(--primary);font-size:0.9rem;margin:0;"><i class="fas fa-map-marker-alt" style="margin-right:8px;"></i>Showing products for <strong>${userLocation.country}${userLocation.city ? ', ' + userLocation.city : ''}</strong></p></div>` : '';
            
            container.innerHTML = regionInfo + products.map((product, index) => {
                // Escape product data for safe JSON encoding
                const productData = JSON.stringify({
                    title: product.title || '',
                    retailer: product.retailer || '',
                    price: product.price || 0,
                    image: product.image || '',
                    clicks: product.clicks || 0,
                    revenue: product.revenue || 0,
                    rating: product.rating || null
                }).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                
                return `
                <div style="display:flex;gap:15px;padding:15px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:15px;background:white;align-items:center;">
                    <div style="position:relative;">
                        <span style="position:absolute;top:-8px;left:-8px;background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600;">${index + 1}</span>
                        <img src="${product.image || 'https://via.placeholder.com/100'}" alt="${product.title}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;" onerror="this.onerror=null; this.src='https://via.placeholder.com/100?text=Product';">
                    </div>
                    <div style="flex:1;">
                        <h4 style="margin:0 0 5px 0;">${product.title}</h4>
                        <p style="color:var(--gray);font-size:0.9rem;margin:0 0 10px 0;">
                            <span style="text-transform:capitalize;">${product.retailer || 'Unknown'}</span> • 
                            <span style="font-weight:600;color:var(--primary);">$${product.price ? product.price.toFixed(2) : '0.00'}</span>
                        </p>
                        <div style="display:flex;gap:20px;font-size:0.9rem;">
                            <span><i class="fas fa-mouse-pointer" style="color:var(--primary);margin-right:5px;"></i>${product.clicks || 0} clicks</span>
                            <span><i class="fas fa-dollar-sign" style="color:var(--success);margin-right:5px;"></i>$${product.revenue ? product.revenue.toFixed(2) : '0.00'} revenue</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-secondary btn-sm" data-product='${productData}' onclick="addToLibraryFromData(this)" style="padding:8px 16px;font-size:0.9rem;">
                            <i class="fas fa-plus"></i> Add to Library
                        </button>
                        <button class="btn btn-primary btn-sm" data-product='${productData}' onclick="addToBlockFromData(this)" style="padding:8px 16px;font-size:0.9rem;">
                            <i class="fas fa-cube"></i> Add to Block
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Helper function to add product to library from data attribute
        function addToLibraryFromData(button) {
            try {
                const productData = JSON.parse(button.getAttribute('data-product').replace(/&quot;/g, '"'));
                const product = {
                    ...productData,
                    source: 'api'
                };
                
                if (addProductToLibrary(product)) {
                    showNotification(`"${product.title}" added to product library`, 'success', 'Added to Library');
                    // Refresh product library if on that page
                    if (document.getElementById('products-page') && document.getElementById('products-page').style.display !== 'none') {
                        renderProductsLibrary();
                    }
                } else {
                    showNotification(`"${product.title}" is already in your library`, 'info', 'Already in Library');
                }
            } catch (e) {
                console.error('Error adding product to library:', e);
                showNotification('Failed to add product to library', 'error', 'Error');
            }
        }
        
        // Helper function to add product to block from data attribute (also adds to library)
        function addToBlockFromData(button) {
            try {
                const productData = JSON.parse(button.getAttribute('data-product').replace(/&quot;/g, '"'));
                const product = {
                    ...productData,
                    source: 'api'
                };
                
                // First add to library if not already there
                addProductToLibrary(product);
                
                showNotification(`"${product.title}" added to product selection`, 'success', 'Product Added');
                // Navigate to blocks page or open product selection
                showPage('blocks');
            } catch (e) {
                console.error('Error adding product to block:', e);
                showNotification('Failed to add product to block', 'error', 'Error');
            }
        }
        
        // Legacy helper functions (for backward compatibility)
        function addToLibrary(productTitle, retailer, price, image, clicks) {
            const product = {
                title: productTitle,
                retailer: retailer,
                price: price,
                image: image,
                clicks: clicks || 0,
                source: 'api'
            };
            
            if (addProductToLibrary(product)) {
                showNotification(`"${productTitle}" added to product library`, 'success', 'Added to Library');
                // Refresh product library if on that page
                if (document.getElementById('products-page') && document.getElementById('products-page').style.display !== 'none') {
                    renderProductsLibrary();
                }
            } else {
                showNotification(`"${productTitle}" is already in your library`, 'info', 'Already in Library');
            }
        }
        
        function addToBlock(productTitle, retailer, price, image, clicks) {
            const product = {
                title: productTitle,
                retailer: retailer,
                price: price,
                image: image,
                clicks: clicks || 0,
                source: 'api'
            };
            addProductToLibrary(product);
            showNotification(`"${productTitle}" added to product selection`, 'success', 'Product Added');
            showPage('blocks');
        }

        // Handle settings profile update
        async function handleSettingsProfileUpdate(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('🔧 Settings profile update triggered');
            
            const name = (document.getElementById('userNameSettings')?.value || '').trim();
            const email = (document.getElementById('userEmailSettings')?.value || '').trim();
            const website = (document.getElementById('userWebsiteSettings')?.value || '').trim();
            const avatarUrl = (document.getElementById('userAvatarUrlSettings')?.value || '').trim();
            
            console.log('📝 Form values:', { name, email, website, avatarUrl });
            console.log('👤 Current user before update:', currentUser);
            
            const status = document.getElementById('settingsProfileStatus');
            if (status) { status.style.color = 'var(--gray)'; status.textContent = 'Saving...'; }
            
            // Validate required fields
            if (!name || !email) {
                showNotification('Name and email are required', 'error', 'Validation Error');
                if (status) { status.style.color = 'var(--danger)'; status.textContent = 'Name and email required'; }
                return;
            }
            
            try {
                const updated = await apiRequest('/api/user/profile', { method: 'PUT', body: { name, email, website, avatarUrl }});
                console.log('✅ Backend response:', updated);
                
                // Merge with existing currentUser to preserve all fields
                currentUser = { 
                    ...(currentUser || {}), 
                    ...(updated || {}),
                    name, 
                    email, 
                    website, 
                    avatarUrl 
                };
                
                console.log('💾 Updated currentUser:', currentUser);
                
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                console.log('💾 Saved to localStorage');
                
                // Update sidebar name IMMEDIATELY (before setTimeout)
                const userNameEl = document.querySelector('.user-name');
                if (userNameEl) {
                    userNameEl.textContent = currentUser.name || 'User';
                    console.log('✅ IMMEDIATE sidebar name update to:', currentUser.name);
                }
                
                // Force immediate UI update with a small delay to ensure DOM is ready
                setTimeout(() => {
                    // Update ALL displays in real-time
                    updateUserDisplay();
                    console.log('🔄 Called updateUserDisplay()');
                    
                    // Refresh settings form to show saved values (with currentUser data)
                    populateSettingsForm();
                    console.log('🔄 Called populateSettingsForm()');
                    
                    // Update account page form if it's visible
                    updateAccountForm();
                    console.log('🔄 Called updateAccountForm()');
                    
                    // Verify the update worked
                    const savedUser = JSON.parse(localStorage.getItem('kotaUser') || '{}');
                    console.log('✅ Verification - localStorage user:', savedUser);
                    console.log('✅ Verification - currentUser:', currentUser);
                    
                    // Double-check sidebar name is updated
                    const verifyNameEl = document.querySelector('.user-name');
                    if (verifyNameEl) {
                        console.log('✅ Final verification - Sidebar name is now:', verifyNameEl.textContent);
                    }
                }, 50);
                
                // Show success notification
                showNotification('Profile updated successfully!', 'success', 'Profile Saved');
                if (status) { status.style.color = '#065f46'; status.textContent = 'Saved'; }
            } catch (err) {
                console.error('❌ Error updating profile:', err);
                // Offline fallback
                currentUser = { 
                    ...(currentUser || {}), 
                    name, 
                    email, 
                    website, 
                    avatarUrl 
                };
                
                console.log('💾 Offline fallback - Updated currentUser:', currentUser);
                
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                console.log('💾 Offline fallback - Saved to localStorage');
                
                // Update sidebar name IMMEDIATELY (before setTimeout)
                const userNameEl = document.querySelector('.user-name');
                if (userNameEl) {
                    userNameEl.textContent = currentUser.name || 'User';
                    console.log('✅ IMMEDIATE sidebar name update (offline) to:', currentUser.name);
                }
                
                // Force immediate UI update with a small delay to ensure DOM is ready
                setTimeout(() => {
                    // Update ALL displays in real-time
                    updateUserDisplay();
                    populateSettingsForm();
                    updateAccountForm();
                    
                    // Verify the update worked
                    const savedUser = JSON.parse(localStorage.getItem('kotaUser') || '{}');
                    console.log('✅ Verification - localStorage user:', savedUser);
                    console.log('✅ Verification - currentUser:', currentUser);
                    
                    // Double-check sidebar name is updated
                    const verifyNameEl = document.querySelector('.user-name');
                    if (verifyNameEl) {
                        console.log('✅ Final verification - Sidebar name is now:', verifyNameEl.textContent);
                    }
                }, 50);
                
                showNotification('Profile saved locally (backend offline). Changes visible immediately.', 'warning', 'Saved Offline');
                if (status) { status.style.color = '#065f46'; status.textContent = 'Saved (offline)'; }
            }
        }

        // Handle password change with current password verification
        async function handlePasswordChange(e) {
            if (e) e.preventDefault();
            const current = document.getElementById('currentPassword')?.value || '';
            const next = document.getElementById('newPassword')?.value || '';
            const confirmPw = document.getElementById('confirmPassword')?.value || '';
            const status = document.getElementById('passwordStatus');
            if (status) { status.style.color = 'var(--gray)'; status.textContent = 'Updating password...'; }
            if (!currentUser) { showNotification('Please log in to change your password', 'warning'); if (status) status.textContent=''; return; }
            if (next.length < 6) { showNotification('New password must be at least 6 characters', 'warning', 'Password Requirements'); if (status) status.textContent=''; return; }
            if (next !== confirmPw) { showNotification('New passwords do not match', 'error', 'Password Mismatch'); if (status) status.textContent=''; return; }
            // Offline/local verification fallback
            if (currentUser.password && currentUser.password !== current) {
                showNotification('Current password is incorrect', 'error', 'Authentication Failed');
                if (status) status.textContent='';
                return;
            }
            try {
                await apiRequest('/api/user/password', { method: 'PUT', body: { currentPassword: current, newPassword: next }});
                // If backend succeeds, we can update local cache too
                currentUser.password = next;
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                if (status) { status.style.color = '#065f46'; status.textContent = 'Password updated'; }
                // Clear fields
                document.getElementById('currentPassword').value='';
                document.getElementById('newPassword').value='';
                document.getElementById('confirmPassword').value='';
                showNotification('Password updated successfully', 'success', 'Password Saved');
            } catch (_) {
                // Offline fallback: update local only
                currentUser.password = next;
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                if (status) { status.style.color = '#065f46'; status.textContent = 'Password updated (offline)'; }
                document.getElementById('currentPassword').value='';
                document.getElementById('newPassword').value='';
                document.getElementById('confirmPassword').value='';
                showNotification('Password saved locally (backend offline)', 'warning', 'Saved Offline');
            }
        }
        
        // Auto-save profile fields (name, email, website, avatar) on blur and with debounced input
        function setupAutoSaveProfileFields() {
            let saveTimeout = null;
            const DEBOUNCE_DELAY = 1000; // 1 second after user stops typing
            
            const nameInput = document.getElementById('userNameSettings');
            const emailInput = document.getElementById('userEmailSettings');
            const websiteInput = document.getElementById('userWebsiteSettings');
            const avatarInput = document.getElementById('userAvatarUrlSettings');
            
            // Debounced auto-save function
            const debouncedAutoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    autoSaveProfile();
                }, DEBOUNCE_DELAY);
            };
            
            // Auto-save function (without form submission event)
            const autoSaveProfile = async () => {
                if (!currentUser) return;
                
                const name = (nameInput?.value || '').trim();
                const email = (emailInput?.value || '').trim();
                const website = (websiteInput?.value || '').trim();
                const avatarUrl = (avatarInput?.value || '').trim();
                
                // Only save if name and email are filled (required fields)
                if (!name || !email) return;
                
                console.log('💾 Auto-saving profile:', { name, email, website, avatarUrl });
                
                const status = document.getElementById('settingsProfileStatus');
                if (status) { 
                    status.style.color = 'var(--gray)'; 
                    status.textContent = 'Saving...'; 
                }
                
                try {
                    const updated = await apiRequest('/api/user/profile', { method: 'PUT', body: { name, email, website, avatarUrl }});
                    console.log('✅ Auto-save backend response:', updated);
                    
                    // Merge with existing currentUser to preserve all fields
                    currentUser = { 
                        ...(currentUser || {}), 
                        ...(updated || {}),
                        name, 
                        email, 
                        website, 
                        avatarUrl 
                    };
                    
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    
                    // Update sidebar name IMMEDIATELY
                    const userNameEl = document.querySelector('.user-name');
                    if (userNameEl) {
                        userNameEl.textContent = currentUser.name || 'User';
                    }
                    
                    // Update all displays
                    setTimeout(() => {
                        updateUserDisplay();
                        populateSettingsForm();
                        updateAccountForm();
                    }, 50);
                    
                    if (status) { 
                        status.style.color = '#065f46'; 
                        status.textContent = 'Saved automatically'; 
                    }
                } catch (err) {
                    console.error('❌ Auto-save error:', err);
                    // Offline fallback
                    currentUser = { 
                        ...(currentUser || {}), 
                        name, 
                        email, 
                        website, 
                        avatarUrl 
                    };
                    
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    
                    // Update sidebar name IMMEDIATELY
                    const userNameEl = document.querySelector('.user-name');
                    if (userNameEl) {
                        userNameEl.textContent = currentUser.name || 'User';
                    }
                    
                    setTimeout(() => {
                        updateUserDisplay();
                        populateSettingsForm();
                        updateAccountForm();
                    }, 50);
                    
                    if (status) { 
                        status.style.color = '#065f46'; 
                        status.textContent = 'Saved automatically (offline)'; 
                    }
                }
            };
            
            // Attach event listeners
            if (nameInput) {
                nameInput.addEventListener('input', debouncedAutoSave);
                nameInput.addEventListener('blur', autoSaveProfile);
            }
            if (emailInput) {
                emailInput.addEventListener('input', debouncedAutoSave);
                emailInput.addEventListener('blur', autoSaveProfile);
            }
            if (websiteInput) {
                websiteInput.addEventListener('input', debouncedAutoSave);
                websiteInput.addEventListener('blur', autoSaveProfile);
            }
            if (avatarInput) {
                avatarInput.addEventListener('input', debouncedAutoSave);
                avatarInput.addEventListener('blur', autoSaveProfile);
            }
            
            console.log('✅ Auto-save profile fields initialized');
        }
        
        // Auto-save password when all fields are filled and user leaves confirm field
        function setupAutoSavePassword() {
            const currentPwInput = document.getElementById('currentPassword');
            const newPwInput = document.getElementById('newPassword');
            const confirmPwInput = document.getElementById('confirmPassword');
            
            if (!currentPwInput || !newPwInput || !confirmPwInput) return;
            
            // Auto-save when user leaves confirm password field (if all fields are filled)
            confirmPwInput.addEventListener('blur', () => {
                const current = currentPwInput.value || '';
                const next = newPwInput.value || '';
                const confirmPw = confirmPwInput.value || '';
                
                // Only auto-save if all three fields are filled
                if (current && next && confirmPw && next === confirmPw) {
                    console.log('💾 Auto-saving password (all fields filled and match)');
                    handlePasswordChange(null); // Pass null instead of event
                }
            });
            
            console.log('✅ Auto-save password initialized');
        }
        // Feature mode: 'live' (default) or 'mock' (set by Reject button)
        function isMockMode() {
            return (localStorage.getItem('kotaMode') || 'live') === 'mock';
        }
        function setMode(mode) {
            localStorage.setItem('kotaMode', mode);
        }

        // Connection status UI
        function setConnectionStatus(ok) {
            let pill = document.getElementById('backendStatusPill');
            if (!pill) {
                pill = document.createElement('span');
                pill.id = 'backendStatusPill';
                pill.style = 'margin-left:10px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;';
                const header = document.querySelector('.header');
                if (header) header.appendChild(pill);
            }
            pill.textContent = ok ? 'API: Connected' : 'API: Offline (mock)';
            pill.style.background = ok ? '#dcfce7' : '#fee2e2';
            pill.style.color = ok ? '#166534' : '#991b1b';
        }

        async function pingBackend() {
            try {
                const res = await fetch(API_BASE + '/');
                if (res.ok) { setConnectionStatus(true); return true; }
                // try alternate
                const res2 = await fetch(ALT_BASE + '/');
                const ok = res2.ok;
                setConnectionStatus(ok);
                if (ok) API_BASE = ALT_BASE;
                return ok;
            } catch (_) {
                try {
                    const res2 = await fetch(ALT_BASE + '/');
                    const ok2 = res2.ok;
                    setConnectionStatus(ok2);
                    if (ok2) API_BASE = ALT_BASE;
                    return ok2;
                } catch (_) {
                    setConnectionStatus(false);
                    return false;
                }
            }
        }

        // Custom Notification System
        function showNotification(message, type = 'info', title = null) {
            // Remove existing notifications
            const existing = document.querySelectorAll('.notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Set icon based on type
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-exclamation-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            
            // Set title based on type if not provided
            const displayTitle = title || (type === 'success' ? 'Success' : type === 'error' ? 'Error' : type === 'warning' ? 'Warning' : 'Info');
            
            notification.innerHTML = `
                <i class="${icon} notification-icon"></i>
                <div class="notification-content">
                    ${title !== null ? `<div class="notification-title">${displayTitle}</div>` : ''}
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.closest('.notification').remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds (or 3 seconds for errors)
            const duration = type === 'error' ? 5000 : 4000;
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Initialize the dashboard
        async function initDashboard() {
            // Inject accept/reject banner once
            injectChangeBanner();

            // Resolve API base dynamically (works for file:// and http://)
            try {
                if (location.protocol === 'file:') {
                    API_BASE = 'http://localhost:3000';
                } else if (location.origin && (location.origin.includes('localhost:3000') || location.origin.includes('127.0.0.1:3000'))) {
                    API_BASE = '';
                } else {
                    API_BASE = 'http://localhost:3000';
                }
            } catch (_) { API_BASE = 'http://localhost:3000'; }

            // Check backend reachability, auto-fallback to mock if offline, try localhost if needed
            let apiOk = await pingBackend();
            if (!apiOk && location.protocol !== 'http:' && location.protocol !== 'https:') {
                API_BASE = 'http://localhost:3000';
                apiOk = await pingBackend();
            }
            if (!apiOk) setMode('mock');

            // Load product library
            loadProductLibrary();
            
            // Detect user's location via IP geolocation
            await detectUserLocation();
            
            // Check if user is logged in
            const savedUser = localStorage.getItem('kotaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserDisplay();
                // Always try to load live data first, only fall back to mock if backend is unavailable
                loadLiveData().catch(() => {
                    console.log('Backend unavailable, using mock data');
                    loadMockData();
                });
                // Check for hash-based routing first, then fall back to plan-based routing
                const hash = window.location.hash.replace('#', '');
                if (hash && ['dashboard', 'blocks', 'integrations', 'analytics', 'account', 'ai-assistant'].includes(hash)) {
                    goToPage(hash);
                } else {
                    // Default to Dashboard
                    goToPage('dashboard');
                }
            } else {
                showLoginModal();
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Verify logo images are loaded
            setTimeout(() => {
                const logoImages = document.querySelectorAll('.logo img');
                logoImages.forEach(img => {
                    if (img.complete && img.naturalHeight === 0) {
                        console.warn('Logo image failed to load:', img.src);
                        img.style.display = 'none';
                        const fallback = img.nextElementSibling;
                        if (fallback) fallback.style.display = 'block';
                    } else {
                        img.style.display = 'block';
                        img.style.visibility = 'visible';
                    }
                });
            }, 500);
        }
        // Simple accept/reject banner
        function injectChangeBanner() {
            if (document.getElementById('acceptRejectBanner')) return;
            const banner = document.createElement('div');
            banner.id = 'acceptRejectBanner';
            banner.style = 'position:fixed;bottom:20px;right:20px;z-index:2000;background:#111;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:flex;align-items:center;gap:10px;';
            banner.innerHTML = `
                <span style="font-weight:600;">Apply assistant changes?</span>
                <button id="acceptBtn" class="btn btn-primary" style="padding:6px 12px;border-radius:8px;">Accept</button>
                <button id="rejectBtn" class="btn btn-secondary" style="padding:6px 12px;border-radius:8px;">Reject</button>
            `;
            document.body.appendChild(banner);
            document.getElementById('acceptBtn').addEventListener('click', () => {
                setMode('live');
                authToken = localStorage.getItem('kotaToken') || authToken;
                banner.remove();
                // reload data live
                if (currentUser && authToken) {
                    loadLiveData();
                    navigateAfterAuth('accept');
                }
            });
            document.getElementById('rejectBtn').addEventListener('click', () => {
                setMode('mock');
                banner.remove();
                // clear token to ensure mock path
                localStorage.removeItem('kotaToken');
                authToken = null;
                // reload mock data
                loadMockData();
                navigateAfterAuth('reject');
            });
        }

        // Load mock data (fallback mode)
        function loadMockData() {
            currentBlocks = [
                {
                    id: 'blk_1',
                    title: 'Best Headphones 2024',
                    layout: 'grid',
                    ctaText: 'Buy Now',
                    products: 3,
                    clicks: 1247,
                    revenue: 89.42,
                    ctr: 3.2,
                    lastUpdated: '2024-05-15',
                    status: 'active',
                    retailer: 'amazon',
                    productsList: [
                        { id: 'amz_1', title: 'Sony WH-1000XM5', image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=500&q=80', price: 299.99, retailer: 'amazon' },
                        { id: 'amz_2', title: 'Bose QuietComfort 45', image: 'https://images.unsplash.com/photo-1572536147248-ac59a8abfa4b?auto=format&fit=crop&w=500&q=80', price: 279.99, retailer: 'amazon' },
                        { id: 'amz_3', title: 'Apple AirPods Max', image: 'https://images.unsplash.com/photo-1613040809024-b4ef7ba99bc3?auto=format&fit=crop&w=500&q=80', price: 549.00, retailer: 'amazon' }
                    ]
                },
                {
                    id: 'blk_2',
                    title: 'Top Smart TVs',
                    layout: 'carousel',
                    ctaText: 'Check Price',
                    products: 2,
                    clicks: 892,
                    revenue: 67.85,
                    ctr: 2.8,
                    lastUpdated: '2024-05-14',
                    status: 'active',
                    retailer: 'walmart',
                    productsList: [
                        { id: 'wlm_1', title: 'Samsung 55" Crystal UHD', image: 'https://images.unsplash.com/photo-1593305841991-05c297ba4575?auto=format&fit=crop&w=500&q=80', price: 499.99, retailer: 'walmart' },
                        { id: 'wlm_2', title: 'Dyson V11 Vacuum', image: 'https://images.unsplash.com/photo-1588872657578-7efd1f1555ed?auto=format&fit=crop&w=500&q=80', price: 599.00, retailer: 'walmart' }
                    ]
                }
            ];
            currentIntegrations = [
                { id: 'amazon', name: 'Amazon Associates', status: 'connected', lastSync: '2 hours ago', affiliateId: 'john-20' },
                { id: 'walmart', name: 'Walmart Affiliate', status: 'connected', lastSync: '1 day ago', affiliateId: 'walmart-123' },
                { id: 'shopify', name: 'Shopify Partner', status: 'disconnected', lastSync: 'Never', affiliateId: '' },
                { id: 'skimlinks', name: 'Skimlinks', status: 'connected', lastSync: '3 hours ago', affiliateId: 'skim-456' }
            ];
            updateDashboardStats();
            renderIntegrations();
            renderActivityTable();
            renderAnalytics();
            renderAlerts();
            // Restore sensitive state after data loads
            setTimeout(() => {
                initializeSensitiveState();
                restoreSensitiveState();
            }, 100);
        }

            // Navigate helpers
        function goToPage(target) {
            showPage(target);
            navLinks.forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`.nav-link[data-page="${target}"]`);
            if (link) link.classList.add('active');
            try { window.location.hash = `#${target}`; } catch (_) {}
            try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch(_) {}
        }

            // Navigate user to plan-specific dashboard section
            function navigateAfterAuth(reason) {
            if (!currentUser) return;
            const plan = currentUser.plan;
            // Choose landing page per plan
            let target = 'dashboard';
            if (plan === 'starter') target = 'dashboard';
            if (plan === 'pro') target = 'analytics';
            if (plan === 'creatorplus') target = 'integrations';
            if (plan === 'agency') target = 'integrations';
            // Defer a tick to ensure DOM is ready after data loads
            setTimeout(() => goToPage(target), 0);
        }

        // Load live data from backend
        async function loadLiveData() {
            try {
                const profile = await apiRequest('/api/user/profile');
                // Only update currentUser if we got valid profile data from backend
                if (profile && profile.email) {
                    currentUser = profile;
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    updateUserDisplay();
                } else {
                    // Backend returned invalid data, keep existing currentUser from localStorage
                    console.warn('Backend returned invalid profile, keeping cached user data');
                    if (!currentUser) {
                        const saved = localStorage.getItem('kotaUser');
                        if (saved) currentUser = JSON.parse(saved);
                    }
                    updateUserDisplay();
                }

                currentBlocks = await apiRequest('/api/blocks');
                currentIntegrations = await apiRequest('/api/integrations');

                // Update dashboard
                updateDashboardStats();
                renderIntegrations();
                renderActivityTable();
                await renderAnalytics();
                await renderAlerts();
            } catch (e) {
                console.error('Error loading live data:', e);
                // Keep currentUser from localStorage, only load mock blocks/integrations
                if (!currentUser) {
                    const saved = localStorage.getItem('kotaUser');
                    if (saved) {
                        currentUser = JSON.parse(saved);
                        updateUserDisplay();
                    }
                }
                // As a last resort, load mock data for blocks/integrations (but keep real user)
                loadMockData();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            function toggleSidebar() {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('expanded');
                
                // Show/hide inline toggle buttons
                const inlineToggles = document.querySelectorAll('.inline-toggle-btn');
                if (sidebar.classList.contains('hidden')) {
                    inlineToggles.forEach(btn => btn.style.display = 'block');
                } else {
                    inlineToggles.forEach(btn => btn.style.display = 'none');
                }
                
                // Update button icons
                const sidebarIcon = sidebarToggle.querySelector('i');
                if (sidebar.classList.contains('hidden')) {
                    sidebarIcon.className = 'fas fa-bars';
                } else {
                    sidebarIcon.className = 'fas fa-times';
                }
            }
            
            // Add event listener to sidebar toggle button
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Add event listeners to all inline toggle buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.inline-toggle-btn')) {
                    toggleSidebar();
                }
            });
            
            
            // Keyboard shortcut (Ctrl/Cmd + B)
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    toggleSidebar();
                }
            });

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                    
                    // Update active nav link
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Button actions
            createBlockBtn.addEventListener('click', () => showNewBlockPage());
            newBlockBtn.addEventListener('click', () => showNewBlockPage());
            backToBlocksBtn.addEventListener('click', () => showPage('blocks'));
            cancelNewBlock.addEventListener('click', () => showPage('blocks'));
            // SmartBlocks quick action buttons
            const sbCreate = document.getElementById('sbCreateBlockBtn');
            if (sbCreate) sbCreate.addEventListener('click', () => showNewBlockPage());
            const sbOpenLib = document.getElementById('sbOpenLibraryBtn');
            if (sbOpenLib) sbOpenLib.addEventListener('click', () => showPage('products'));
            document.querySelectorAll('.sb-layout').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.sb-layout').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    showNotification('Layout set to: ' + this.getAttribute('data-layout'), 'info', 'Layout Selected');
                });
            });
            const sbAddAff = document.getElementById('sbAddAffiliateBtn');
            if (sbAddAff) sbAddAff.addEventListener('click', () => showNotification('Add Affiliate Product feature coming soon', 'info'));
            const sbAddShop = document.getElementById('sbAddShopifyBtn');
            if (sbAddShop) sbAddShop.addEventListener('click', () => showNotification('Add Shopify Product feature coming soon', 'info'));
            const sbColors = document.getElementById('sbCustomizeColorsBtn');
            if (sbColors) sbColors.addEventListener('click', () => showNotification('Customize Colors feature coming soon', 'info'));
            const sbHeadline = document.getElementById('sbCustomizeHeadlineBtn');
            if (sbHeadline) sbHeadline.addEventListener('click', () => showNotification('Customize Headline feature coming soon', 'info'));
            const sbCta = document.getElementById('sbCustomizeCtaBtn');
            if (sbCta) sbCta.addEventListener('click', () => showNotification('Customize Button Text feature coming soon', 'info'));
            const sbPreview = document.getElementById('sbPreviewBtn');
            if (sbPreview) sbPreview.addEventListener('click', () => showNotification('Preview feature coming soon', 'info'));
            const sbEmbed = document.getElementById('sbGenerateEmbedBtn');
            if (sbEmbed) sbEmbed.addEventListener('click', () => showNotification('Generate Embed Code feature coming soon', 'info'));
            
            // Logout
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('kotaUser');
                localStorage.removeItem('kotaToken');
                currentUser = null;
                authToken = null;
                // Use relative path that works for both local and GitHub Pages
                const basePath = window.location.pathname.replace(/\/[^/]*$/, '/');
                window.location.href = basePath + 'index.html';
            });

            // Modal close buttons
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    loginModal.style.display = 'none';
                    signupModal.style.display = 'none';
                });
            });

            // Show modals
            showLogin.addEventListener('click', function(e) {
                e.preventDefault();
                signupModal.style.display = 'none';
                loginModal.style.display = 'block';
            });

            // Settings: avatar file upload → preview + URL field + auto-save
            const avatarFileInput = document.getElementById('userAvatarFileSettings');
            const avatarUrlInput = document.getElementById('userAvatarUrlSettings');
            const avatarPreview = document.getElementById('settingsAvatarPreview');
            if (avatarFileInput && avatarUrlInput && avatarPreview) {
                avatarFileInput.addEventListener('change', function() {
                    const file = this.files && this.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        const dataUrl = ev.target.result;
                        avatarUrlInput.value = dataUrl;
                        avatarPreview.src = dataUrl;
                        // Trigger auto-save after avatar is loaded by dispatching input event
                        // This will use the debounced auto-save from setupAutoSaveProfileFields
                        setTimeout(() => {
                            avatarUrlInput.dispatchEvent(new Event('input', { bubbles: true }));
                            // Also trigger blur to save immediately
                            setTimeout(() => {
                                avatarUrlInput.dispatchEvent(new Event('blur', { bubbles: true }));
                            }, 50);
                        }, 100);
                    };
                    reader.readAsDataURL(file);
                });
            }
            showSignup.addEventListener('click', function(e) {
                e.preventDefault();
                loginModal.style.display = 'none';
                signupModal.style.display = 'block';
            });

            // Form submissions
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            profileForm.addEventListener('submit', handleProfileUpdate);
            newBlockForm.addEventListener('submit', handleCreateBlock);
            
            // Copy API key
            copyApiKey.addEventListener('click', function() {
                navigator.clipboard.writeText('sk_live_51JQ3x8H4bK7X9cY8aB2C1dE3fG4hI5jK6lM7nO8pQ9rS0tU1vW2xY3zA4');
                showNotification('API key copied to clipboard!', 'success', 'Copied');
            });

            // Settings profile form - Auto-save on blur and debounced input
            const settingsProfileForm = document.getElementById('settingsProfileForm');
            if (settingsProfileForm) {
                // Remove any existing listeners to prevent duplicates
                const newForm = settingsProfileForm.cloneNode(true);
                settingsProfileForm.parentNode.replaceChild(newForm, settingsProfileForm);
                // Add event listener to the new form (as fallback)
                document.getElementById('settingsProfileForm').addEventListener('submit', function(e) {
                    console.log('📋 Settings form submit event triggered');
                    handleSettingsProfileUpdate(e);
                });
                console.log('✅ Settings profile form event listener attached');
                
                // Auto-save functionality for profile fields
                setupAutoSaveProfileFields();
            } else {
                console.warn('⚠️ settingsProfileForm not found');
            }

            // Password form - Auto-save when all fields are filled
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordChange);
                // Auto-save password when all fields are filled and user leaves confirm field
                setupAutoSavePassword();
            }
            
            // Affiliate API Keys form
            const affiliateKeysForm = document.getElementById('affiliateKeysForm');
            if (affiliateKeysForm) {
                affiliateKeysForm.addEventListener('submit', handleAffiliateKeysSubmit);
            }

            // Layout selection
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentLayout = this.getAttribute('data-layout');
                });
            });

            // Plan card selection syncs with dropdown
            document.querySelectorAll('.plan-card').forEach(card => {
                card.addEventListener('click', function() {
                    const plan = this.getAttribute('data-plan');
                    const select = document.getElementById('signupPlan');
                    select.value = plan;
                    document.querySelectorAll('.plan-card').forEach(c => c.style.border = '2px solid #e5e7eb');
                    this.style.border = '2px solid var(--primary)';
                });
            });

            // Retailer selection
            retailerSelect.addEventListener('change', function() {
                if (this.value) {
                    searchProducts(this.value, 'headphones');
                }
            });

            // Product search
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (retailerSelect.value && this.value.trim()) {
                        searchProducts(retailerSelect.value, this.value);
                    }
                }
            });

            // Filters
            dateRangeFilter.addEventListener('change', renderAnalytics);
            retailerFilter.addEventListener('change', renderAnalytics);
            
            // Product Library Filter Buttons
            document.querySelectorAll('.product-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.product-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filter = this.getAttribute('data-filter');
                    filterProductsBySource(filter);
                });
            });
            
            // Product Library Sort Buttons
            document.querySelectorAll('.product-sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.product-sort-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const sortBy = this.getAttribute('data-sort');
                    sortProducts(sortBy);
                });
            });
            
            // Product Library Tag Buttons
            document.querySelectorAll('.product-tag-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const tag = this.getAttribute('data-tag');
                    filterProductsByTag(tag);
                });
            });
            
            // Add New Product Button
            const addNewProductBtn = document.getElementById('addNewProductBtn');
            if (addNewProductBtn) {
                addNewProductBtn.addEventListener('click', function() {
                    showNotification('Add New Product feature coming soon', 'info');
                    // This can open a modal or navigate to a form
                });
            }
        }

        // Update toggle button state
        function updateToggleButtonState() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle) {
                const sidebarIcon = sidebarToggle.querySelector('i');
                if (sidebar.classList.contains('hidden')) {
                    sidebarIcon.className = 'fas fa-bars';
                } else {
                    sidebarIcon.className = 'fas fa-times';
                }
            }
            
            // Show/hide inline toggle buttons based on sidebar state
            const inlineToggles = document.querySelectorAll('.inline-toggle-btn');
            inlineToggles.forEach(btn => {
                if (sidebar.classList.contains('hidden')) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        // Show new block page (only accessible from SmartBlocks page)
        function showNewBlockPage() {
            // Hide all pages
            currentPage.style.display = 'none';
            blocksPage.style.display = 'none';
            newBlockPage.style.display = 'block';
            integrationsPage.style.display = 'none';
            analyticsPage.style.display = 'none';
            accountPage.style.display = 'none';
            
            // Update navigation
            navLinks.forEach(l => l.classList.remove('active'));
            const link = document.querySelector('.nav-link[data-page="blocks"]');
            if (link) link.classList.add('active');
            
            // Update URL hash
            try { window.location.hash = '#blocks'; } catch (_) {}
            try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch(_) {}
            
            // Update toggle button state
            updateToggleButtonState();
        }

        // Show page
        function showPage(page) {
            // Initialize auto-save when Settings page is shown
            if (page === 'settings') {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    setupAutoSaveProfileFields();
                    setupAutoSavePassword();
                }, 100);
            }
            // Redirect new-block to blocks page since it's not in main navigation
            if (page === 'new-block') {
                page = 'blocks';
            }
            
            // Check password for settings page
            if (page === 'settings') {
                if (!checkSettingsAccess()) {
                    return; // Access denied, don't show page
                }
            }
            
            // Check password for settings page
            if (page === 'settings') {
                if (!checkSettingsAccess()) {
                    return; // Access denied, don't show page
                }
            }
            
            // Hide all pages
            currentPage.style.display = 'none';
            blocksPage.style.display = 'none';
            newBlockPage.style.display = 'none';
            integrationsPage.style.display = 'none';
            analyticsPage.style.display = 'none';
            accountPage.style.display = 'none';
            if (productsPage) productsPage.style.display = 'none';
            if (aiAssistantPage) aiAssistantPage.style.display = 'none';
            if (settingsPage) settingsPage.style.display = 'none';
            if (billingPage) billingPage.style.display = 'none';

            // Show selected page
            switch(page) {
                case 'dashboard':
                    currentPage.style.display = 'block';
                    setTimeout(() => {
                        initializeSensitiveState();
                        restoreSensitiveState();
                    }, 50);
                    // Show global toggle button for dashboard
                    const dashboardToggle = document.getElementById('globalSensitiveToggle');
                    if (dashboardToggle) dashboardToggle.style.display = 'flex';
                    const analyticsToggle = document.getElementById('globalSensitiveToggleAnalytics');
                    if (analyticsToggle) analyticsToggle.style.display = 'none';
                    break;
                case 'blocks':
                    blocksPage.style.display = 'block';
                    break;
                case 'integrations':
                    integrationsPage.style.display = 'block';
                    break;
                case 'analytics':
                    analyticsPage.style.display = 'block';
                    renderAnalytics();
                    setTimeout(() => {
                        initializeSensitiveState();
                        restoreSensitiveState();
                    }, 50);
                    // Show global toggle button for analytics
                    const dashboardToggle2 = document.getElementById('globalSensitiveToggle');
                    if (dashboardToggle2) dashboardToggle2.style.display = 'none';
                    const analyticsToggle2 = document.getElementById('globalSensitiveToggleAnalytics');
                    if (analyticsToggle2) analyticsToggle2.style.display = 'flex';
                    break;
                case 'account':
                    accountPage.style.display = 'block';
                    updateAccountForm();
                    break;
                case 'products':
                    if (productsPage) {
                        productsPage.style.display = 'block';
                        renderProductsLibrary();
                    }
                    break;
                case 'ai-assistant':
                    if (aiAssistantPage) aiAssistantPage.style.display = 'block';
                    break;
                case 'settings':
                    if (settingsPage) {
                        // Check password access first
                        if (!checkSettingsAccess()) {
                            // Access denied, hide settings page and go back to previous page
                            settingsPage.style.display = 'none';
                            // Go back to dashboard if access denied
                            goToPage('dashboard');
                            return;
                        }
                        settingsPage.style.display = 'block';
                        populateSettingsForm();
                        loadTopPerformingProducts();
                        // Initialize auto-save after form is populated
                        setTimeout(() => {
                            setupAutoSaveProfileFields();
                            setupAutoSavePassword();
                        }, 150);
                    }
                    break;
                case 'billing':
                    if (billingPage) billingPage.style.display = 'block';
                    break;
            }
            
            // Update toggle button state to maintain consistency
            updateToggleButtonState();
        }

        // Show login modal
        function showLoginModal() {
            // If a user exists locally (from index.html login or previous session), bypass modal
            const saved = localStorage.getItem('kotaUser');
            if (saved) {
                try {
                    currentUser = JSON.parse(saved);
                    // Ensure token exists
                    if (!authToken) {
                        authToken = localStorage.getItem('kotaToken') || 'db_token_' + btoa(currentUser.email || 'user');
                        localStorage.setItem('kotaToken', authToken);
                    }
                    updateUserDisplay();
                    // Try to load live data first (to get latest from backend), fallback to mock if offline
                    loadLiveData().catch(() => {
                        console.log('Backend unavailable, using cached user data and mock blocks');
                        loadMockData();
                    });
                    navigateAfterAuth('offline');
                    return;
                } catch (e) {
                    console.error('Error loading saved user:', e);
                }
            }
            loginModal.style.display = 'block';
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const status = document.getElementById('loginStatus');
            const btn = document.getElementById('loginSubmit');
            if (status) { status.style.color = 'var(--gray)'; status.textContent = 'Signing you in...'; }
            if (btn) { btn.disabled = true; btn.textContent = 'Logging in...'; }
            
            // Try embedded database first (same as index.html)
            try {
                if (window.userDB) {
                    const user = window.userDB.authenticateUser(email, password);
                    // Create user object without password
                    const { password: _, ...userWithoutPassword } = user;
                    currentUser = userWithoutPassword;
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    localStorage.setItem('kotaToken', 'db_token_' + btoa(user.email));
                    authToken = localStorage.getItem('kotaToken');
                    updateUserDisplay();
                    loginModal.style.display = 'none';
                    showNotification('Welcome back ' + user.name + '!', 'success', 'Welcome!');
                    loadMockData();
                    navigateAfterAuth('login-db');
                    if (status) status.textContent = '';
                    if (btn) { btn.disabled = false; btn.textContent = 'Login'; }
                    return;
                }
            } catch (dbError) {
                console.log('Database auth failed, trying API:', dbError.message);
            }
            
            // Fallback to API or mock mode
            if (isMockMode()) {
                // In mock mode, try to use the actual user from localStorage first (from index.html login)
                const savedUser = localStorage.getItem('kotaUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        // Verify email matches (security check)
                        if (currentUser.email && currentUser.email.toLowerCase() !== email.toLowerCase()) {
                            throw new Error('Email mismatch');
                        }
                    } catch (e) {
                        // If saved user doesn't match or doesn't exist, create minimal user object
                        currentUser = { 
                            id: 'user_' + Date.now(), 
                            name: email.split('@')[0], 
                            email: email.toLowerCase(), 
                            plan: 'starter', 
                            createdAt: new Date().toISOString() 
                        };
                    }
                } else {
                    // No saved user, create minimal user object
                    currentUser = { 
                        id: 'user_' + Date.now(), 
                        name: email.split('@')[0], 
                        email: email.toLowerCase(), 
                        plan: 'starter', 
                        createdAt: new Date().toISOString() 
                    };
                }
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                updateUserDisplay();
                loginModal.style.display = 'none';
                loadMockData();
                navigateAfterAuth('login-mock');
                if (status) status.textContent = '';
                if (btn) { btn.disabled = false; btn.textContent = 'Login'; }
            } else {
                try {
                    const resp = await apiRequest('/api/auth/login', { method: 'POST', body: { email, password } });
                    authToken = resp.token;
                    localStorage.setItem('kotaToken', authToken);
                    currentUser = resp.user;
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    updateUserDisplay();
                    loginModal.style.display = 'none';
                    await loadLiveData();
                    // use server-provided redirect suggestion
                    if (resp.redirectPage) {
                        showPage(resp.redirectPage);
                        navLinks.forEach(l => l.classList.remove('active'));
                        document.querySelector(`.nav-link[data-page="${resp.redirectPage}"]`)?.classList.add('active');
                        try { window.location.hash = `#${resp.redirectPage}`; } catch(_) {}
                    } else {
                        navigateAfterAuth('login');
                    }
                    if (status) status.textContent = '';
                } catch (err) {
                    if (status) { status.style.color = 'var(--danger)'; status.textContent = err.message || 'Login failed'; }
                }
                if (btn) { btn.disabled = false; btn.textContent = 'Login'; }
            }
        }

        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const website = document.getElementById('signupWebsite').value;
            const plan = document.getElementById('signupPlan').value;
            
            // Try embedded database first (same as index.html)
            try {
                if (window.userDB) {
                    const userData = {
                        name: name,
                        email: email.toLowerCase().trim(),
                        password: password,
                        website: website || '',
                        plan: plan,
                        settings: { notifications: true, theme: 'light' }
                    };
                    const newUser = window.userDB.createUser(userData);
                    // Create user object without password
                    const { password: _, ...userWithoutPassword } = newUser;
                    currentUser = userWithoutPassword;
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    localStorage.setItem('kotaToken', 'db_token_' + btoa(newUser.email));
                    authToken = localStorage.getItem('kotaToken');
                    updateUserDisplay();
                    signupModal.style.display = 'none';
                    showNotification('Account created successfully! Welcome ' + name + '!', 'success', 'Welcome!');
                    loadMockData();
                    navigateAfterAuth('signup-db');
                    return;
                }
            } catch (dbError) {
                if (dbError.message.includes('already exists')) {
                    showNotification('An account with this email already exists. Please try logging in instead.', 'warning', 'Account Exists');
                    return;
                }
                console.log('Database signup failed, trying API:', dbError.message);
            }
            
            // Fallback to API or mock mode
            if (isMockMode()) {
                currentUser = { id: 'user_' + Date.now(), name, email, plan, createdAt: new Date().toISOString().split('T')[0] };
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                updateUserDisplay();
                signupModal.style.display = 'none';
                loadMockData();
                navigateAfterAuth('signup-mock');
            } else {
                try {
                    const resp = await apiRequest('/api/auth/register', { method: 'POST', body: { name, email, password, website, plan } });
                    authToken = resp.token;
                    localStorage.setItem('kotaToken', authToken);
                    currentUser = resp.user;
                    localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                    updateUserDisplay();
                    signupModal.style.display = 'none';
                    await loadLiveData();
                    // use server-provided redirect suggestion
                    if (resp.redirectPage) {
                        showPage(resp.redirectPage);
                        navLinks.forEach(l => l.classList.remove('active'));
                        document.querySelector(`.nav-link[data-page="${resp.redirectPage}"]`)?.classList.add('active');
                        try { window.location.hash = `#${resp.redirectPage}`; } catch(_) {}
                    } else {
                        navigateAfterAuth('signup');
                    }
                } catch (err) {
                    showNotification(err.message || 'Signup failed', 'error', 'Signup Failed');
                }
            }
        }

        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const website = document.getElementById('userWebsite').value;
            try {
                const updated = await apiRequest('/api/user/profile', { method: 'PUT', body: { name, email, website } });
                currentUser = updated || { ...(currentUser || {}), name, email, website };
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                updateUserDisplay();
                showNotification('Profile updated successfully!', 'success', 'Profile Saved');
            } catch (err) {
                // Offline/local fallback: update cached user so UI still reflects changes
                currentUser = { ...(currentUser || {}), name, email, website };
                localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                updateUserDisplay();
                // Let the user know backend is offline but their local profile was updated
                showNotification('Profile saved locally (backend offline). Your dashboard will use the updated info.', 'warning', 'Saved Offline');
            }
        }

        // Handle create block
        async function handleCreateBlock(e) {
            e.preventDefault();
            const title = document.getElementById('blockTitle').value;
            const ctaText = document.getElementById('ctaText').value;
            
            if (!title.trim()) {
                showNotification('Please add a title for your block', 'warning', 'Required Field');
                return;
            }
            
            if (selectedProductsList.length === 0) {
                showNotification('Please select at least one product', 'warning', 'Selection Required');
                return;
            }
            
            try {
                const created = await apiRequest('/api/blocks', {
                    method: 'POST',
                    body: { title, layout: currentLayout, ctaText, productsList: selectedProductsList }
                });
                currentBlocks.push(created);
            } catch (err) {
                showNotification(err.message || 'Could not create block', 'error', 'Creation Failed');
                return;
            }
            
            // Reset form
            document.getElementById('blockTitle').value = '';
            document.getElementById('ctaText').value = 'Buy Now';
            selectedProductsList = [];
            selectedCount.textContent = '0';
            selectedProducts.innerHTML = '';
            productsContainer.innerHTML = '';
            productSearch.value = '';
            searchStatus.textContent = '';
            
            // Go to blocks page
            showPage('blocks');
            updateDashboardStats();
            
            showNotification('Block created successfully!', 'success', 'Block Created');
        }

        // Update user display
        function updateUserDisplay() {
            if (!currentUser) {
                console.warn('⚠️ updateUserDisplay called but currentUser is null');
                return;
            }
            
            console.log('🔄 updateUserDisplay called with:', currentUser);
            
            // Update sidebar name (force immediate update)
            const userNameEl = document.querySelector('.user-name');
            if (userNameEl) {
                // Force a reflow to ensure the update is visible
                userNameEl.style.display = 'none';
                userNameEl.offsetHeight; // Trigger reflow
                userNameEl.style.display = '';
                userNameEl.textContent = currentUser.name || 'User';
                console.log('✅ Updated sidebar name to:', currentUser.name);
            } else {
                console.warn('⚠️ .user-name element not found');
                // Try alternative selector
                const altNameEl = document.querySelector('.user-info .user-name');
                if (altNameEl) {
                    altNameEl.textContent = currentUser.name || 'User';
                    console.log('✅ Updated sidebar name (alternative selector) to:', currentUser.name);
                }
            }
            
            // Update plan
            const planElement = document.querySelector('.user-plan');
            if (planElement) {
                const plan = currentUser.plan || 'starter';
                planElement.textContent = 
                    plan === 'starter' ? 'Starter Plan' : 
                    plan === 'pro' ? 'Pro Plan' : 
                    plan === 'creatorplus' ? 'Creator+ Plan' : 
                    plan === 'agency' ? 'Agency Plan' : 'Unknown Plan';
                planElement.className = 'user-plan ' + plan;
                console.log('✅ Updated plan to:', plan);
            }
            
            // Update sidebar avatar
            const avatarImg = document.getElementById('sidebarUserAvatar');
            if (avatarImg) {
                if (currentUser.avatarUrl) {
                    avatarImg.src = currentUser.avatarUrl;
                    console.log('✅ Updated avatar to:', currentUser.avatarUrl);
                } else {
                    avatarImg.src = 'https://i.pravatar.cc/40?img=1';
                }
            }
            
            // Update account form fields with current user data
            updateAccountForm();
            
            // Update billing section with user's actual plan
            updateBillingSection();
            renderBillingHistory();
            populateSettingsForm();
            
            // Update plan info on dashboard
            updatePlanInfo();
            
            console.log('✅ updateUserDisplay completed');
        }

        // Update account form with current user data
        function updateAccountForm() {
            if (currentUser) {
                const nameField = document.getElementById('userName');
                const emailField = document.getElementById('userEmail');
                const websiteField = document.getElementById('userWebsite');
                
                if (nameField) nameField.value = currentUser.name || '';
                if (emailField) emailField.value = currentUser.email || '';
                if (websiteField) websiteField.value = currentUser.website || '';
                
                // Update billing section with user's actual plan
                updateBillingSection();
            }
        }

        // Update billing section based on user's actual plan
        function updateBillingSection() {
            if (!currentUser) return;
            
            const currentPlan = currentUser.plan;
            // Prefer billing page container if present; fallback to account page
            const container = document.getElementById('billingPlansContainerBilling') || document.getElementById('billingPlansContainer');
            if (!container) return;
            
            // Define all plans with their details
            const allPlans = [
                {
                    id: 'starter',
                    name: 'Starter Plan',
                    price: '$0.00',
                    features: [
                        '5 product blocks',
                        'Amazon only',
                        'Basic analytics',
                        'Community support'
                    ]
                },
                {
                    id: 'pro',
                    name: 'Pro Plan',
                    price: '$19.00',
                    features: [
                        '50 product blocks',
                        'All retailers (Amazon, Walmart, Shopify)',
                        'Full analytics dashboard',
                        'Click & conversion tracking',
                        'Email + chat support'
                    ]
                },
                {
                    id: 'creatorplus',
                    name: 'Creator+ Plan',
                    price: '$49.00',
                    features: [
                        'Unlimited product blocks',
                        'All retailers + custom integrations',
                        'AI-powered recommendations',
                        'SmartAlerts for performance changes',
                        'Export reports (PDF/CSV)',
                        'Priority support'
                    ]
                },
                {
                    id: 'agency',
                    name: 'Agency Plan',
                    price: '$199.00',
                    features: [
                        'Everything in Creator+',
                        'White-label solution',
                        'Multi-client management',
                        'Custom branding & domains',
                        'API access & webhooks',
                        'Dedicated account manager'
                    ]
                }
            ];
            
            // Clear container
            container.innerHTML = '';
            
            // First, show the current plan (highlighted)
            const currentPlanData = allPlans.find(plan => plan.id === currentPlan);
            if (currentPlanData) {
                const currentPlanCard = createPlanCard(currentPlanData, true);
                container.appendChild(currentPlanCard);
            }
            
            // Then show all other plans (excluding current)
            allPlans.forEach(plan => {
                if (plan.id !== currentPlan) {
                    const planCard = createPlanCard(plan, false);
                    container.appendChild(planCard);
                }
            });
        }

        // Render simple billing history (mock/offline friendly)
        function renderBillingHistory() {
            const historyEl = document.getElementById('billingHistory');
            if (!historyEl) return;
            // Example/mock entries; replace with API results when available
            const invoices = [
                { date: '2024-05-01', amount: 19.00, status: 'Paid', id: 'INV-1001' },
                { date: '2024-04-01', amount: 19.00, status: 'Paid', id: 'INV-0962' },
                { date: '2024-03-01', amount: 19.00, status: 'Paid', id: 'INV-0920' }
            ];
            historyEl.innerHTML = '';
            invoices.forEach(inv => {
                const row = document.createElement('div');
                row.className = 'invoice-item';
                row.innerHTML = `
                    <div class="invoice-date">${inv.date} • <span style="color:#6b7280;">${inv.id}</span></div>
                    <div class="invoice-amount">$${inv.amount.toFixed(2)}</div>
                    <div class="invoice-status">${inv.status}</div>
                `;
                historyEl.appendChild(row);
            });
        }
        
        // Helper function to create plan cards
        function createPlanCard(planData, isCurrent) {
            const card = document.createElement('div');
            card.className = 'card';
            if (isCurrent) {
                card.style.border = '2px solid var(--primary)';
            }
            
            const featuresList = planData.features.map(feature => 
                `<li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> ${feature}</li>`
            ).join('');
            
            card.innerHTML = `
                <div style="text-align: center; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                    ${isCurrent ? '<span style="background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">Current Plan</span>' : ''}
                    <h3 style="margin: 15px 0;">${planData.name}</h3>
                    <div class="stat-value">${planData.price}</div>
                    <div class="stat-label">per month</div>
                </div>
                <ul style="list-style: none; padding: 20px 0; text-align: left;">
                    ${featuresList}
                </ul>
                <button class="btn ${isCurrent ? 'btn-secondary' : 'btn-primary'}" style="width: 100%;" onclick="changePlan('${planData.id}')">
                    ${isCurrent ? 'Current Plan' : 'Select Plan'}
                </button>
            `;
            
            return card;
        }

        // Update plan-specific information
        function updatePlanInfo() {
            if (!currentUser) return;
            const planInfo = document.getElementById('planInfo');
            const plan = currentUser.plan;
            
            let info = '';
            if (plan === 'starter') {
                info = 'Free plan • 5 blocks max • Amazon only • Basic analytics';
            } else if (plan === 'pro') {
                info = 'Pro plan • 50 blocks • All retailers • Full analytics • Click tracking';
            } else if (plan === 'creatorplus') {
                info = 'Creator+ plan • Unlimited blocks • All retailers • AI recommendations • SmartAlerts';
            } else if (plan === 'agency') {
                info = 'Agency plan • White-label • Multi-client • API access • Dedicated support';
            }
            
            planInfo.textContent = info;
        }

        // Update dashboard stats
        // Global toggle for all sensitive information visibility
        function toggleAllSensitive() {
            const sensitiveElements = document.querySelectorAll('[data-sensitive="true"]');
            const globalToggleBtn = document.getElementById('globalSensitiveToggle') || document.getElementById('globalSensitiveToggleAnalytics');
            const globalToggleIcon = globalToggleBtn ? globalToggleBtn.querySelector('i') : null;
            const globalToggleText = globalToggleBtn ? globalToggleBtn.querySelector('span') : null;
            
            // Check if any sensitive element is visible
            let anyVisible = false;
            sensitiveElements.forEach(element => {
                if (!element.classList.contains('hidden')) {
                    anyVisible = true;
                }
            });
            
            // Toggle all elements
            sensitiveElements.forEach(element => {
                if (anyVisible) {
                    // Hide all
                    element.classList.add('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'hidden');
                } else {
                    // Show all
                    element.classList.remove('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'visible');
                }
            });
            
            // Update global toggle button
            if (globalToggleBtn && globalToggleIcon && globalToggleText) {
                if (anyVisible) {
                    globalToggleIcon.classList.remove('fa-eye');
                    globalToggleIcon.classList.add('fa-eye-slash');
                    globalToggleText.textContent = 'Show Sensitive Data';
                } else {
                    globalToggleIcon.classList.remove('fa-eye-slash');
                    globalToggleIcon.classList.add('fa-eye');
                    globalToggleText.textContent = 'Hide Sensitive Data';
                }
            }
            
            // Store global state
            localStorage.setItem('sensitive_global_state', anyVisible ? 'hidden' : 'visible');
        }
        
        // Update global toggle button state
        function updateGlobalToggleState() {
            const sensitiveElements = document.querySelectorAll('[data-sensitive="true"]');
            const globalToggleBtn = document.getElementById('globalSensitiveToggle') || document.getElementById('globalSensitiveToggleAnalytics');
            const globalToggleIcon = globalToggleBtn ? globalToggleBtn.querySelector('i') : null;
            const globalToggleText = globalToggleBtn ? globalToggleBtn.querySelector('span') : null;
            
            if (!globalToggleBtn || !globalToggleIcon || !globalToggleText) return;
            
            // Check if any sensitive element is visible
            let anyVisible = false;
            sensitiveElements.forEach(element => {
                if (!element.classList.contains('hidden')) {
                    anyVisible = true;
                }
            });
            
            if (anyVisible) {
                globalToggleIcon.classList.remove('fa-eye-slash');
                globalToggleIcon.classList.add('fa-eye');
                globalToggleText.textContent = 'Hide Sensitive Data';
            } else {
                globalToggleIcon.classList.remove('fa-eye');
                globalToggleIcon.classList.add('fa-eye-slash');
                globalToggleText.textContent = 'Show Sensitive Data';
            }
        }
        
        // Restore sensitive information visibility state
        function restoreSensitiveState() {
            const globalState = localStorage.getItem('sensitive_global_state');
            const sensitiveElements = document.querySelectorAll('[data-sensitive="true"]');
            
            // Use global state if available, otherwise default to hidden
            const shouldBeVisible = globalState === 'visible';
            
            sensitiveElements.forEach(element => {
                if (shouldBeVisible) {
                    element.classList.remove('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'visible');
                } else {
                    element.classList.add('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'hidden');
                }
            });
            
            // Update global toggle button state
            updateGlobalToggleState();
        }
        
        // Initialize sensitive info as hidden on page load (default state)
        function initializeSensitiveState() {
            const sensitiveElements = document.querySelectorAll('[data-sensitive="true"]');
            const globalState = localStorage.getItem('sensitive_global_state');
            
            // Default to hidden if no global state exists
            const shouldBeVisible = globalState === 'visible';
            
            sensitiveElements.forEach(element => {
                if (shouldBeVisible) {
                    element.classList.remove('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'visible');
                } else {
                    element.classList.add('hidden');
                    localStorage.setItem('sensitive_' + element.id, 'hidden');
                }
            });
            
            // Update global toggle button state
            updateGlobalToggleState();
        }
        
        // Detect user location via IP geolocation
        async function detectUserLocation() {
            try {
                // Try multiple free geolocation APIs
                const apis = [
                    'https://ipapi.co/json/',
                    'https://ip-api.com/json/',
                    'https://api.ipify.org?format=json'
                ];
                
                // Try ipapi.co first (most reliable)
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('https://ipapi.co/json/', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        const data = await response.json();
                        userLocation = {
                            country: data.country_name || data.country || null,
                            countryCode: data.country_code || data.country || null,
                            region: data.region || data.regionName || null,
                            city: data.city || null,
                            ip: data.ip || null,
                            timezone: data.timezone || null
                        };
                        console.log('✅ User location detected:', userLocation);
                        localStorage.setItem('kotaUserLocation', JSON.stringify(userLocation));
                        return;
                    }
                } catch (e) {
                    console.log('ipapi.co failed, trying alternative...');
                }
                
                // Fallback to ip-api.com
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('https://ip-api.com/json/', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        const data = await response.json();
                        userLocation = {
                            country: data.country || null,
                            countryCode: data.countryCode || null,
                            region: data.regionName || null,
                            city: data.city || null,
                            ip: data.query || null,
                            timezone: data.timezone || null
                        };
                        console.log('✅ User location detected (fallback):', userLocation);
                        localStorage.setItem('kotaUserLocation', JSON.stringify(userLocation));
                        return;
                    }
                } catch (e) {
                    console.log('ip-api.com failed, using cached or default...');
                }
                
                // Use cached location if available
                const cached = localStorage.getItem('kotaUserLocation');
                if (cached) {
                    userLocation = JSON.parse(cached);
                    console.log('✅ Using cached location:', userLocation);
                } else {
                    // Default to US if detection fails
                    userLocation = { country: 'United States', countryCode: 'US', region: null, city: null, ip: null };
                    console.log('⚠️ Location detection failed, defaulting to US');
                }
            } catch (error) {
                console.error('Location detection error:', error);
                // Use cached or default
                const cached = localStorage.getItem('kotaUserLocation');
                if (cached) {
                    userLocation = JSON.parse(cached);
                } else {
                    userLocation = { country: 'United States', countryCode: 'US', region: null, city: null, ip: null };
                }
            }
        }
        
        // Check settings page access (password protection)
        function checkSettingsAccess() {
            const accessGranted = sessionStorage.getItem('settingsAccessGranted');
            if (accessGranted === 'true') {
                return true;
            }
            
            const password = prompt('Enter password to access Settings:');
            if (!password) {
                showNotification('Access denied. Password required to view Settings.', 'warning', 'Access Denied');
                return false;
            }
            
            // Check password against current user's password
            if (currentUser && currentUser.password === password) {
                sessionStorage.setItem('settingsAccessGranted', 'true');
                showNotification('Access granted', 'success', 'Settings Unlocked');
                return true;
            } else {
                showNotification('Incorrect password. Access denied.', 'error', 'Access Denied');
                return false;
            }
        }

        function updateDashboardStats() {
            if (currentBlocks.length === 0) return;
            
            const totalClicks = currentBlocks.reduce((sum, block) => sum + block.clicks, 0);
            const totalRevenue = currentBlocks.reduce((sum, block) => sum + block.revenue, 0);
            const avgCTR = currentBlocks.length > 0 ? (currentBlocks.reduce((sum, block) => sum + block.ctr, 0) / currentBlocks.length) : 0;
            const activeBlocks = currentBlocks.filter(block => block.status === 'active').length;
            
            const elTotalClicks = document.getElementById('totalClicks');
            if (elTotalClicks) elTotalClicks.textContent = totalClicks.toLocaleString();
            const elEstRevenue = document.getElementById('estimatedRevenue');
            if (elEstRevenue) elEstRevenue.textContent = '$' + totalRevenue.toFixed(2);
            const elAvgCTR = document.getElementById('avgCTR');
            if (elAvgCTR) elAvgCTR.textContent = avgCTR.toFixed(1) + '%';
            const elActiveBlocks = document.getElementById('activeBlocks') || document.getElementById('totalBlocks');
            if (elActiveBlocks) elActiveBlocks.textContent = activeBlocks;
        }

        // Render blocks
        function renderBlocks() {
            // Function removed - blocks no longer displayed on dashboard
            return;
        }

        // Render integrations
        function renderIntegrations() {
            const container = document.getElementById('integrationsContainer');
            container.innerHTML = '';
            
            currentIntegrations.forEach(integration => {
                const integrationCard = document.createElement('div');
                integrationCard.className = 'card';
                integrationCard.innerHTML = `
                    <div class="card-header">
                        <h3 class="card-title">${integration.name}</h3>
                        <span class="block-status ${integration.status === 'connected' ? 'status-active' : 'status-draft'}">
                            ${integration.status === 'connected' ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    <div class="card-body">
                        <p>Last synced: ${integration.lastSync}</p>
                        ${integration.status === 'connected' ? `
                            <div class="form-group">
                                <label>Affiliate ID</label>
                                <input type="text" value="${integration.affiliateId}" class="form-control integration-id" data-id="${integration.id}">
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-danger disconnect-btn" data-id="${integration.id}">Disconnect</button>
                                <button class="btn btn-secondary sync-btn" data-id="${integration.id}">Sync Now</button>
                            </div>
                        ` : `
                            <p>Connect your ${integration.name} account to start creating SmartBlocks with their products.</p>
                            <button class="btn btn-primary connect-btn" data-id="${integration.id}">Connect Account</button>
                        `}
                    </div>
                `;
                container.appendChild(integrationCard);
            });
            
            // Add event listeners
            document.querySelectorAll('.connect-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const integrationId = this.getAttribute('data-id');
                    apiRequest(`/api/integrations/${integrationId}/connect`, { method: 'POST', body: {} })
                      .then(updated => {
                          const idx = currentIntegrations.findIndex(i => i.id === integrationId);
                          if (idx !== -1) currentIntegrations[idx] = updated;
                          else currentIntegrations.push(updated);
                        renderIntegrations();
                        showNotification('Integration connected successfully!', 'success', 'Connected');
                      })
                      .catch(err => showNotification(err.message || 'Connect failed', 'error', 'Connection Failed'));
                });
            });
            
            document.querySelectorAll('.disconnect-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const integrationId = this.getAttribute('data-id');
                    apiRequest(`/api/integrations/${integrationId}/disconnect`, { method: 'POST', body: {} })
                      .then(updated => {
                          const idx = currentIntegrations.findIndex(i => i.id === integrationId);
                          if (idx !== -1) currentIntegrations[idx] = updated;
                        renderIntegrations();
                        showNotification('Integration disconnected successfully!', 'success', 'Disconnected');
                      })
                      .catch(err => showNotification(err.message || 'Disconnect failed', 'error', 'Disconnect Failed'));
                });
            });
            
            document.querySelectorAll('.sync-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const integrationId = this.getAttribute('data-id');
                    apiRequest(`/api/integrations/${integrationId}/sync`, { method: 'POST', body: {} })
                      .then(updated => {
                          const idx = currentIntegrations.findIndex(i => i.id === integrationId);
                          if (idx !== -1) currentIntegrations[idx] = updated;
                        renderIntegrations();
                        showNotification('Integration synced successfully!', 'success', 'Synced');
                      })
                      .catch(err => showNotification(err.message || 'Sync failed', 'error', 'Sync Failed'));
                });
            });
            
            document.querySelectorAll('.integration-id').forEach(input => {
                input.addEventListener('change', function() {
                    const integrationId = this.getAttribute('data-id');
                    apiRequest('/api/integrations', { method: 'POST', body: { id: integrationId, name: integrationId, affiliateId: this.value } })
                      .then(updated => {
                          const idx = currentIntegrations.findIndex(i => i.id === integrationId);
                          if (idx !== -1) currentIntegrations[idx] = updated;
                          renderIntegrations();
                        showNotification('Affiliate ID updated successfully!', 'success', 'Updated');
                      })
                      .catch(err => showNotification(err.message || 'Update failed', 'error', 'Update Failed'));
                });
            });
        }

        // Render activity table
        function renderActivityTable() {
            const tbody = document.querySelector('#activityTable tbody');
            tbody.innerHTML = '';
            
            currentBlocks.slice(0, 5).forEach(block => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${block.title}</td>
                    <td>${block.layout}</td>
                    <td>${block.clicks}</td>
                    <td>$${block.revenue.toFixed(2)}</td>
                    <td><span class="block-status ${block.status === 'active' ? 'status-active' : 'status-draft'}">${block.status}</span></td>
                    <td>${block.lastUpdated}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render analytics
        async function renderAnalytics() {
            const dateRange = dateRangeFilter.value;
            const retailer = retailerFilter.value;
            
            try {
                const metrics = await apiRequest(`/api/analytics?dateRange=${encodeURIComponent(dateRange)}&retailer=${encodeURIComponent(retailer)}`);
                const elFC = document.getElementById('filteredClicks');
                if (elFC) elFC.textContent = (metrics.totalClicks || 0).toLocaleString();
                const elFR = document.getElementById('filteredRevenue');
                if (elFR) elFR.textContent = '$' + (metrics.totalRevenue || 0).toFixed(2);
                const elFCTR = document.getElementById('filteredCTR');
                if (elFCTR) elFCTR.textContent = (metrics.avgCTR || 0).toFixed(1) + '%';
                const filteredBlocks = retailer === 'all' ? currentBlocks : currentBlocks.filter(b => b.retailer === retailer);
            const elBS = document.getElementById('blocksShowing');
            if (elBS) elBS.textContent = filteredBlocks.length;
            
            const tbody = document.querySelector('#analyticsTable tbody');
            tbody.innerHTML = '';
            filteredBlocks.forEach(block => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${block.title}</td>
                    <td>${block.layout}</td>
                    <td>${block.clicks}</td>
                    <td>${block.ctr}%</td>
                    <td>$${block.revenue.toFixed(2)}</td>
                    <td><span class="block-status ${block.status === 'active' ? 'status-active' : 'status-draft'}">${block.status}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" style="padding: 5px 10px; font-size: 0.8rem;">Edit</button>
                        <button class="btn btn-secondary btn-sm" style="padding: 5px 10px; font-size: 0.8rem;">Analytics</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            } catch (err) {
                console.error(err);
            }
            
            // Load real-time performance data
            loadPerformanceData(retailer);
        }

        // Load real-time performance data from retailer APIs
        async function loadPerformanceData(retailer = 'all') {
            const container = document.getElementById('performanceDataContainer');
            
            try {
                // Get all product IDs from user's blocks
                const allProductIds = currentBlocks.flatMap(block => 
                    block.productsList ? block.productsList.map(product => product.id) : []
                );
                
                if (allProductIds.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">No products to analyze. Create some blocks first!</div>';
                    return;
                }
                
                // Load performance data for each retailer
                const retailers = retailer === 'all' ? ['amazon', 'shopify', 'walmart', 'skimlinks'] : [retailer];
                const performanceData = [];
                
                for (const retail of retailers) {
                    try {
                        const data = await apiRequest(`/api/products/performance?retailer=${retail}&productIds=${allProductIds.join(',')}`);
                        performanceData.push(data);
                    } catch (error) {
                        console.error(`Failed to load ${retail} data:`, error);
                    }
                }
                
                // Display performance data
                displayPerformanceData(performanceData);
                
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load performance data: ${error.message}</div>`;
            }
        }

        // Display performance data in a table format
        function displayPerformanceData(performanceData) {
            const container = document.getElementById('performanceDataContainer');
            
            if (performanceData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">No performance data available</div>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<thead><tr style="background: var(--light-gray);">';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Retailer</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Products</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Avg Conversion</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Avg CTR</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Total Revenue</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Last Updated</th>';
            html += '</tr></thead><tbody>';
            
            performanceData.forEach(data => {
                const retailerName = data.retailer.charAt(0).toUpperCase() + data.retailer.slice(1);
                const lastUpdated = new Date(data.products[0]?.lastUpdated || Date.now()).toLocaleString();
                
                html += '<tr style="border-bottom: 1px solid var(--border);">';
                html += `<td style="padding: 12px;"><strong>${retailerName}</strong></td>`;
                html += `<td style="padding: 12px;">${data.summary.totalProducts}</td>`;
                html += `<td style="padding: 12px; color: #10b981; font-weight: 600;">${data.summary.avgConversionRate}</td>`;
                html += `<td style="padding: 12px; color: #3b82f6; font-weight: 600;">${data.summary.avgClickThroughRate}</td>`;
                html += `<td style="padding: 12px; color: #f59e0b; font-weight: 600;">$${data.summary.totalRevenue.toLocaleString()}</td>`;
                html += `<td style="padding: 12px; font-size: 0.9rem; color: var(--gray);">${lastUpdated}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // Add refresh button
            html += '<div style="text-align: center; margin-top: 20px;">';
            html += '<button class="btn btn-primary" onclick="loadPerformanceData()">Refresh Data</button>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Render alerts
        async function renderAlerts() {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';
            try {
                const alerts = await apiRequest('/api/alerts');
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                const cls = alert.type === 'warning' ? 'warning' : (alert.type === 'success' ? 'success' : 'danger');
                alertDiv.className = `alert alert-${cls}`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${alert.type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <div>
                        <strong>${alert.title}</strong>
                        <p>${alert.message}</p>
                    </div>
                `;
                container.appendChild(alertDiv);
            });
            } catch (err) {
                console.error(err);
            }
        }

        // Search products
        async function searchProducts(retailer, query) {
            searchStatus.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            productsContainer.innerHTML = '';
            try {
                const products = await apiRequest(`/api/products/search?retailer=${encodeURIComponent(retailer)}&query=${encodeURIComponent(query)}`, {
                    method: 'POST',
                    body: { location: userLocation }
                });
                const regionMsg = userLocation.country ? ` in ${userLocation.country}` : '';
                searchStatus.textContent = `Found ${products.length} products for "${query}"${regionMsg}`;
                
                // Automatically add searched products to library
                if (products && products.length > 0) {
                    const added = addProductsToLibrary(products.map(p => ({ ...p, source: 'api', retailer: retailer }))) || 0;
                    if (added > 0) {
                        showNotification(`${added} product(s) added to library`, 'success', 'Products Added');
                        if (document.getElementById('products-page')?.style.display !== 'none') {
                            renderProductsLibrary();
                        }
                    }
                }
                
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    
                    // Add performance indicators
                    const performanceBadge = product.performance ? 
                        `<div class="performance-badge" style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-top: 5px;">
                            ${product.performance.conversionRate}% conversion
                        </div>` : '';
                    
                    const retailerSpecific = getRetailerSpecificInfo(product, retailer);
                    
                    productCard.innerHTML = `
                        <img src="${product.image}" alt="${product.title}" class="product-image">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        <div class="product-retailer">${retailer.charAt(0).toUpperCase() + retailer.slice(1)}</div>
                        ${retailerSpecific}
                        ${performanceBadge}
                    `;
                    productCard.addEventListener('click', function() {
                        const isSelected = selectedProductsList.some(p => p.id === product.id);
                        
                        if (isSelected) {
                            selectedProductsList = selectedProductsList.filter(p => p.id !== product.id);
                        } else {
                            // Check limit based on plan
                            const maxProducts = currentUser?.plan === 'starter' ? 3 : 
                                               currentUser?.plan === 'pro' ? 10 : 20;
                            
                            if (selectedProductsList.length >= maxProducts) {
                                showNotification(`Maximum ${maxProducts} products allowed per block in your plan.`, 'warning', 'Plan Limit');
                                return;
                            }
                            
                            selectedProductsList.push(product);
                        }
                        
                        updateSelectedProducts();
                    });
                    productsContainer.appendChild(productCard);
                });
            } catch (err) {
                searchStatus.textContent = 'Search failed';
            }
        }

        // Get retailer-specific information display
        function getRetailerSpecificInfo(product, retailer) {
            switch (retailer) {
                case 'amazon':
                    return `
                        <div class="retailer-info" style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                            <div>⭐ ${product.rating} (${product.reviewCount} reviews)</div>
                            <div>Rank: #${product.salesRank}</div>
                            ${product.primeEligible ? '<div style="color: #ff9900;">✓ Prime Eligible</div>' : ''}
                        </div>
                    `;
                case 'shopify':
                    return `
                        <div class="retailer-info" style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                            <div>📊 ${product.views} views, ${product.orders} orders</div>
                            <div>📦 ${product.inventory} in stock</div>
                        </div>
                    `;
                case 'walmart':
                    return `
                        <div class="retailer-info" style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                            <div>⭐ ${product.rating} (${product.reviewCount} reviews)</div>
                            <div>${product.pickupAvailable ? '✓ Pickup' : ''} ${product.deliveryAvailable ? '✓ Delivery' : ''}</div>
                        </div>
                    `;
                case 'skimlinks':
                    return `
                        <div class="retailer-info" style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                            <div>💰 ${product.commission}% commission</div>
                            <div>👆 ${product.clicks} clicks, ${product.conversions} conversions</div>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Update selected products display
        function updateSelectedProducts() {
            selectedCount.textContent = selectedProductsList.length;
            selectedProducts.innerHTML = '';
            
            selectedProductsList.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.style = 'background: #f5f7fa; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px;';
                productDiv.innerHTML = `
                    <img src="${product.image}" alt="${product.title}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                    <div>
                        <div style="font-weight: 600; font-size: 0.8rem;">${product.title}</div>
                        <div style="font-size: 0.7rem; color: var(--gray);">$${product.price.toFixed(2)}</div>
                    </div>
                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.7rem;" data-id="${product.id}">Remove</button>
                `;
                selectedProducts.appendChild(productDiv);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('[data-id]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    selectedProductsList = selectedProductsList.filter(p => p.id !== productId);
                    updateSelectedProducts();
                });
            });
        }

        // Handle plan changes
        async function changePlan(newPlan) {
            if (!currentUser) {
                showNotification('Please log in to change your plan', 'warning', 'Authentication Required');
                return;
            }
            
            if (currentUser.plan === newPlan) {
                showNotification('You are already on this plan', 'info', 'Current Plan');
                return;
            }
            
            const planNames = {
                'starter': 'Starter',
                'pro': 'Pro',
                'creatorplus': 'Creator+',
                'agency': 'Agency'
            };
            
            const currentPlanName = planNames[currentUser.plan] || 'Current';
            const newPlanName = planNames[newPlan] || 'New';
            
            if (confirm(`Are you sure you want to change from ${currentPlanName} to ${newPlanName} plan?`)) {
                try {
                    const response = await apiRequest('/api/user/profile', {
                        method: 'PUT',
                        body: { plan: newPlan }
                    });
                    
                    if (response) {
                        currentUser.plan = newPlan;
                        localStorage.setItem('kotaUser', JSON.stringify(currentUser));
                        
                        // Update the UI
                        updateBillingSection();
                        updatePlanInfo();
                        updateUserDisplay();
                        
                        showNotification(`Successfully changed to ${newPlanName} plan!`, 'success', 'Plan Updated');
                    }
                } catch (error) {
                    console.error('Plan change error:', error);
                    showNotification('Failed to change plan. Please try again.', 'error', 'Plan Change Failed');
                }
            }
        }

        // Product Library Functions
        let currentProductFilter = 'all';
        let currentProductSort = 'price';
        let activeProductTags = [];
        let allProducts = [];
        let productLibrary = []; // Global product library storage
        
        // Load product library from localStorage
        function loadProductLibrary() {
            try {
                const saved = localStorage.getItem('kotaProductLibrary');
                if (saved) {
                    productLibrary = JSON.parse(saved);
                } else {
                    productLibrary = [];
                }
            } catch (e) {
                console.error('Error loading product library:', e);
                productLibrary = [];
            }
        }
        
        // Save product library to localStorage
        function saveProductLibrary() {
            try {
                localStorage.setItem('kotaProductLibrary', JSON.stringify(productLibrary));
            } catch (e) {
                console.error('Error saving product library:', e);
            }
        }
        
        // Add product to library (with duplicate check)
        function addProductToLibrary(product) {
            if (!product || !product.title) return false;
            
            if (!productLibrary || productLibrary.length === 0) {
                loadProductLibrary();
            }
            
            // Generate a unique ID if not present
            if (!product.id) {
                product.id = `${product.retailer || 'unknown'}_${product.title.replace(/\s+/g, '_').toLowerCase()}_${Date.now()}`;
            }
            
            // Check if product already exists (by ID or title+retailer)
            const exists = productLibrary.some(p => 
                p.id === product.id || 
                (p.title === product.title && p.retailer === product.retailer)
            );
            
            if (!exists) {
                productLibrary.push({
                    ...product,
                    addedToLibrary: new Date().toISOString(),
                    source: product.source || 'api'
                });
                saveProductLibrary();
                return true;
            }
            return false;
        }
        
        // Add multiple products to library
        function addProductsToLibrary(products) {
            if (!Array.isArray(products)) return;
            let added = 0;
            products.forEach(product => {
                if (addProductToLibrary(product)) {
                    added++;
                }
            });
            return added;
        }
        
        function filterProductsBySource(source) {
            currentProductFilter = source;
            renderProductsLibrary();
        }
        
        function sortProducts(sortBy) {
            currentProductSort = sortBy;
            renderProductsLibrary();
        }
        
        function filterProductsByTag(tag) {
            const idx = activeProductTags.indexOf(tag);
            if (idx > -1) {
                activeProductTags.splice(idx, 1);
            } else {
                activeProductTags.push(tag);
            }
            renderProductsLibrary();
        }
        
        function renderProductsLibrary() {
            const container = document.getElementById('productsLibraryContainer');
            if (!container) return;
            
            // Load product library first
            loadProductLibrary();
            
            // Get products from all blocks
            allProducts = [];
            currentBlocks.forEach(block => {
                if (block.productsList) {
                    block.productsList.forEach(product => {
                        allProducts.push({
                            ...product,
                            blockTitle: block.title,
                            clicks: block.clicks || 0,
                            source: 'block'
                        });
                    });
                }
            });
            
            // Add products from the global product library
            productLibrary.forEach(product => {
                // Check if product is already in allProducts (from blocks)
                const exists = allProducts.some(p => 
                    (p.id && product.id && p.id === product.id) ||
                    (p.title === product.title && p.retailer === product.retailer)
                );
                if (!exists) {
                    allProducts.push({
                        ...product,
                        source: product.source || 'library',
                        blockTitle: product.blockTitle || 'Product Library'
                    });
                }
            });
            
            // Apply source filter
            let filtered = allProducts;
            if (currentProductFilter !== 'all') {
                filtered = filtered.filter(p => p.retailer === currentProductFilter);
            }
            
            // Apply tag filters (if any active)
            if (activeProductTags.length > 0) {
                // Mock tag filtering - in real implementation, tags would be stored on products
                // For now, we'll just show all if tags are selected
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                switch(currentProductSort) {
                    case 'price':
                        return (b.price || 0) - (a.price || 0);
                    case 'clicks':
                        return (b.clicks || 0) - (a.clicks || 0);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    default:
                        return 0;
                }
            });
            
            // Render products
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">No products found matching your filters.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(product => {
                const retailerLabel = product.retailer ? `<span style="text-transform: capitalize;">${product.retailer}</span>` : 'Unknown';
                const originLabel = product.blockTitle || 'Product Library';
                const sourceLabel = (() => {
                    if (product.source === 'amazon-site-stripe') return '(SiteStripe)';
                    if (product.source === 'api') return '(API)';
                    if (product.source && product.source !== 'block' && product.source !== 'library') return `(${product.source})`;
                    return '';
                })();
                const sourceBadge = sourceLabel ? ` <span style="color: var(--primary); font-size: 0.8rem;">${sourceLabel}</span>` : '';
                const ratingBadge = product.rating ? `<span style="color: var(--gray); font-size: 0.9rem;">⭐ ${product.rating}</span>` : '';
                const priceLabel = product.price ? product.price.toFixed(2) : '0.00';
                return `
                <div style="display: flex; gap: 15px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px; background: white;">
                    <img src="${product.image || 'https://via.placeholder.com/100'}" alt="${product.title}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" onerror="this.onerror=null; this.src='https://via.placeholder.com/100?text=' + encodeURIComponent('${product.title.substring(0, 10)}');">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0;">${product.title}</h4>
                        <p style="color: var(--gray); font-size: 0.9rem; margin: 0 0 10px 0;">
                            ${retailerLabel} • 
                            From: ${originLabel}
                            ${sourceBadge}
                        </p>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <span style="font-weight: 600; color: var(--primary); font-size: 1.2rem;">$${priceLabel}</span>
                            <span style="color: var(--gray); font-size: 0.9rem;">Clicks: ${product.clicks || 0}</span>
                            ${ratingBadge}
                        </div>
                        ${product.siteStripeLink ? `<div style="margin-top:8px;"><a href="${product.siteStripeLink}" target="_blank" rel="noopener" style="font-size:0.85rem;color:var(--primary);text-decoration:none;">View on Amazon <i class="fas fa-external-link-alt" style="font-size:0.75rem;margin-left:4px;"></i></a></div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);

        // AI Assistant Functions
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success', 'Copied');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        async function generateBlurb() {
            const productName = document.getElementById('blurbProductName').value;
            const productDetails = document.getElementById('blurbProductDetails').value;
            const tone = document.getElementById('blurbTone').value;
            
            if (!productName) {
                showNotification('Please enter a product name', 'warning', 'Required Field');
                return;
            }
            
            try {
                const response = await apiRequest('/api/ai/generate-blurb', { method: 'POST', body: { productName, productDetails, tone } });
                document.getElementById('blurbResultContent').textContent = response.blurb;
                document.getElementById('blurbResult').style.display = 'block';
            } catch (err) {
                showNotification('Failed to generate blurb. Error: ' + err.message, 'error', 'Generation Failed');
            }
        }

        async function generateProsCons() {
            const productName = document.getElementById('prosConsProductName').value;
            const productDetails = document.getElementById('prosConsProductDetails').value;
            
            if (!productName) {
                showNotification('Please enter a product name', 'warning', 'Required Field');
                return;
            }
            
            try {
                const response = await apiRequest('/api/ai/generate-pros-cons', { method: 'POST', body: { productName, productDetails } });
                const prosList = document.getElementById('prosList');
                const consList = document.getElementById('consList');
                prosList.innerHTML = response.pros.map(p => `<li>${p}</li>`).join('');
                consList.innerHTML = response.cons.map(c => `<li>${c}</li>`).join('');
                document.getElementById('prosConsResult').style.display = 'block';
            } catch (err) {
                showNotification('Failed to generate pros & cons. Error: ' + err.message, 'error', 'Generation Failed');
            }
        }

        async function suggestAlternatives() {
            const productName = document.getElementById('alternativeProductName').value;
            const budget = document.getElementById('alternativeBudget').value;
            
            if (!productName) {
                showNotification('Please enter a product name', 'warning', 'Required Field');
                return;
            }
            
            try {
                const prompt = `Suggest 3 alternative products to "${productName}" ${budget ? 'within ' + budget : ''}. For each, give a name and a one-sentence reason focused on value or features. Return as bullet points: Name — Reason.`;
                const content = await callOpenAI(prompt, { temperature: 0.7, system: 'Be practical and oriented to shopper value.'});
                const container = document.getElementById('alternativesResult');
                const lines = content.split('\n').map(l => l.trim()).filter(Boolean);
                container.innerHTML = lines.map(l => {
                    const parts = l.replace(/^[-•*]\s?/, '').split(' — ');
                    const name = parts[0] || l;
                    const reason = parts.slice(1).join(' — ') || '';
                    return `<div style="padding: 15px; background: #f9fafb; border-radius: 4px; margin-bottom: 10px;">
                        <strong>${name}</strong>
                        <p style=\"color: #666; font-size: 0.9rem;\">${reason}</p>
                    </div>`;
                }).join('');
                container.style.display = 'block';
            } catch (err) {
                showNotification('Failed to suggest alternatives. Error: ' + err.message, 'error', 'Request Failed');
            }
        }

        async function generateFAQ() {
            const productName = document.getElementById('faqProductName').value;
            const productDetails = document.getElementById('faqProductDetails').value;
            const count = parseInt(document.getElementById('faqCount').value);
            
            if (!productName) {
                showNotification('Please enter a product name', 'warning', 'Required Field');
                return;
            }
            
            try {
                const prompt = `Create ${count} SEO-friendly FAQs for the product "${productName}". ${productDetails ? 'Details: ' + productDetails : ''}. Return as Q/A pairs labelled Q: and A: on separate lines for each item.`;
                const content = await callOpenAI(prompt, { temperature: 0.6, system: 'Write helpful, accurate product FAQs.'});
                const container = document.getElementById('faqResult');
                const blocks = content.split(/\n\s*\n/).filter(Boolean);
                container.innerHTML = blocks.map(block => {
                    const lines = block.split('\n');
                    const q = lines.find(l => /^\s*Q:/i.test(l)) || '';
                    const a = lines.find(l => /^\s*A:/i.test(l)) || '';
                    return `<div style="padding: 15px; background: #f9fafb; border-radius: 4px; margin-bottom: 10px;">
                        <strong>${q.replace(/^\s*Q:\s*/i,'Q: ')}</strong>
                        <p style=\"margin-top: 5px; color: #666;\">${a.replace(/^\s*A:\s*/i,'A: ')}</p>
                    </div>`;
                }).join('');
                container.style.display = 'block';
            } catch (err) {
                showNotification('Failed to generate FAQ. Error: ' + err.message, 'error', 'Generation Failed');
            }
        }

        async function importSiteStripeFromSettings() {
            const input = document.getElementById('amazonSiteStripeLink');
            if (!input) return;
            const link = (input.value || '').trim();
            if (!link) {
                showNotification('Please paste a SiteStripe link first', 'warning', 'SiteStripe Link Required');
                return;
            }
            const status = document.getElementById('apiKeysStatus');
            await fetchSiteStripeProducts(link, currentUser?.apiKeys || {}, status);
        }
        
        async function fetchSiteStripeProducts(link, apiKeysOverride = null, statusEl = null) {
            if (!link) return [];
            const trimmedLink = link.trim();
            if (!trimmedLink) return [];
            const originalStatus = statusEl ? statusEl.textContent : '';
            if (statusEl) {
                statusEl.style.color = 'var(--gray)';
                statusEl.textContent = 'Importing SiteStripe products...';
            }
            try {
                const products = await apiRequest('/api/products/site-stripe', {
                    method: 'POST',
                    body: {
                        link: trimmedLink,
                        apiKeys: apiKeysOverride || currentUser?.apiKeys || {}
                    }
                });
                if (Array.isArray(products) && products.length > 0) {
                    const normalized = products.map(product => ({
                        ...product,
                        retailer: product.retailer || 'amazon',
                        siteStripeLink: trimmedLink,
                        source: 'amazon-site-stripe',
                        id: product.id || normalizeSiteStripeId(trimmedLink, product.asin || product.sku || null)
                    }));
                    const added = addProductsToLibrary(normalized) || 0;
                    if (added > 0) {
                        showNotification(`${added} product(s) imported from Amazon SiteStripe`, 'success', 'SiteStripe Import');
                        if (document.getElementById('products-page')?.style.display !== 'none') {
                            renderProductsLibrary();
                        }
                    } else {
                        showNotification('SiteStripe products already exist in your library', 'info', 'No New Products');
                    }
                    return normalized;
                }
                showNotification('No products returned for that SiteStripe link.', 'info', 'SiteStripe Import');
                return [];
            } catch (err) {
                console.error('SiteStripe import failed:', err);
                const fallbackProducts = buildSiteStripeFallback(trimmedLink);
                if (fallbackProducts.length > 0) {
                    const added = addProductsToLibrary(fallbackProducts) || 0;
                    if (added > 0) {
                        showNotification(`${added} product(s) imported from SiteStripe (fallback)`, 'success', 'SiteStripe Fallback');
                        if (document.getElementById('products-page')?.style.display !== 'none') {
                            renderProductsLibrary();
                        }
                    } else {
                        showNotification('SiteStripe products already exist in your library', 'info', 'No New Products');
                    }
                    return fallbackProducts;
                }
                showNotification('Failed to import products from the SiteStripe link. Please check the URL and try again.', 'error', 'SiteStripe Error');
                return [];
            } finally {
                if (statusEl) {
                    statusEl.style.color = '#065f46';
                    statusEl.textContent = originalStatus ? `${originalStatus} • SiteStripe import complete` : 'SiteStripe import complete';
                }
            }
        }
        
        function buildSiteStripeFallback(link) {
            const asin = extractAmazonAsin(link);
            const fallbackId = normalizeSiteStripeId(link, asin);
            const title = asin ? `Amazon Product ${asin}` : 'Amazon SiteStripe Product';
            const image = 'https://images.unsplash.com/photo-1585386959984-a4155222f4c1?auto=format&fit=crop&w=500&q=80';
            return [{
                id: fallbackId,
                asin: asin || null,
                title,
                retailer: 'amazon',
                price: asin ? 59.99 : 39.99,
                image,
                clicks: 0,
                rating: 4.5,
                url: link,
                siteStripeLink: link,
                source: 'amazon-site-stripe'
            }];
        }
        
        function extractAmazonAsin(link) {
            if (!link) return null;
            const asinPathMatch = link.match(/(?:dp|gp\/product|product)\/([A-Z0-9]{10})/i);
            if (asinPathMatch) return asinPathMatch[1].toUpperCase();
            const asinParamMatch = link.match(/(?:asin|ASIN)=([A-Z0-9]{10})/);
            if (asinParamMatch) return asinParamMatch[1].toUpperCase();
            const shortCode = link.split('/').filter(Boolean).pop();
            if (shortCode && shortCode.length >= 6 && shortCode.length <= 12) {
                return shortCode.replace(/[^A-Z0-9]/gi, '').toUpperCase().slice(0, 10) || null;
            }
            return null;
        }
        
        function normalizeSiteStripeId(link, asin) {
            if (asin) return `amazon_${asin.toUpperCase()}`;
            const cleaned = (link || '')
                .replace(/^https?:\/\//i, '')
                .split('?')[0]
                .replace(/[^a-z0-9]/gi, '')
                .toLowerCase();
            if (cleaned.length >= 6) {
                return `amazon_${cleaned.slice(-12)}`;
            }
            return `amazon_${Date.now().toString(36)}`;
        }
    </script>
</body>
</html>